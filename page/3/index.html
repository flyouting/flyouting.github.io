<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <title>flyouting and shirley</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description">
<meta property="og:type" content="website">
<meta property="og:title" content="flyouting and shirley">
<meta property="og:url" content="http://coofee.me/page/3/index.html">
<meta property="og:site_name" content="flyouting and shirley">
<meta property="og:description">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="flyouting and shirley">
<meta name="twitter:description">
  
    <link rel="alternative" href="/atom.xml" title="flyouting and shirley" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="http://ww2.sinaimg.cn/small/4a242739gw1eu09kkcr5xj2050050glt.jpg" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">flyouting and shirley</a></h1>
		</hgroup>

		
		<p class="header-subtitle">记录一点一滴</p>
		

		<!--
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						<div class="icon-wrap icon-link hide" data-idx="2">
							<div class="loopback_l"></div>
							<div class="loopback_r"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>Menu</li>
						<li>Tags</li>
						
						<li>Links</li>
						
						
						<li>Über</li>
						
					</ul>
				</div>
			</div>
		-->

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">首页</a></li>
				        
							<li><a href="/archives">文章列表</a></li>
				        
							<li><a href="/about">关于</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/flyouting" title="github">github</a>
					        
								<a class="weibo" target="_blank" href="http://weibo.com/flyouting" title="weibo">weibo</a>
					        
								<a class="zhihu" target="_blank" href="http://www.zhihu.com/people/flyouting" title="zhihu">zhihu</a>
					        
								<a class="mail" target="_blank" href="mailto:flyouting@gmail.com" title="mail">mail</a>
					        
						</div>
					</nav>
				</section>
				
				<div class="switch-part switch-part2"><script>var n ='b-26003349-pe-f-801';var ch ='pc_6'; var w1 = 200;var h1 = 280;</script> <script src='http://static.luna.58.com/js/mad.js'></script></div>
				
				<!--
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/AndroidStudio/" style="font-size: 10px;">AndroidStudio</a> <a href="/tags/DB/" style="font-size: 12.5px;">DB</a> <a href="/tags/Git/" style="font-size: 10px;">Git</a> <a href="/tags/ImageSpan/" style="font-size: 10px;">ImageSpan</a> <a href="/tags/ORM/" style="font-size: 12.5px;">ORM</a> <a href="/tags/Python/" style="font-size: 12.5px;">Python</a> <a href="/tags/activeandroid/" style="font-size: 10px;">activeandroid</a> <a href="/tags/android/" style="font-size: 17.5px;">android</a> <a href="/tags/intent/" style="font-size: 10px;">intent</a> <a href="/tags/key/" style="font-size: 10px;">key</a> <a href="/tags/layout/" style="font-size: 10px;">layout</a> <a href="/tags/python/" style="font-size: 20px;">python</a> <a href="/tags/span/" style="font-size: 10px;">span</a> <a href="/tags/transitions/" style="font-size: 10px;">transitions</a> <a href="/tags/volley/" style="font-size: 15px;">volley</a> <a href="/tags/webview/" style="font-size: 10px;">webview</a> <a href="/tags/后台，多线程/" style="font-size: 10px;">后台，多线程</a> <a href="/tags/相机/" style="font-size: 15px;">相机</a> <a href="/tags/终端/" style="font-size: 10px;">终端</a> <a href="/tags/设计模式/" style="font-size: 10px;">设计模式</a> <a href="/tags/面试/" style="font-size: 10px;">面试</a>
					</div>
				</section>
				-->
				
				<!--
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">奥巴马的博客</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">卡卡的美丽传说</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">本泽马的博客</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">吉格斯的博客</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">习大大大不同</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">托蒂的博客</a>
			        
			        </div>
				</section>
				

				
				
				<section class="switch-part switch-part4">
				
					<div id="js-aboutme">我是谁，我从哪里来，我到哪里去？我就是我，是颜色不一样的吃货…</div>
				</section>
				-->
			</div>
		</div>
	</header>				
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">flyouting and shirley</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
			
				<img lazy-src="http://ww2.sinaimg.cn/small/4a242739gw1eu09kkcr5xj2050050glt.jpg" class="js-avatar">
			
			</div>
			<hgroup>
			  <h1 class="header-author">flyouting and shirley</h1>
			</hgroup>
			
			<p class="header-subtitle">记录一点一滴</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">首页</a></li>
		        
					<li><a href="/archives">文章列表</a></li>
		        
					<li><a href="/about">关于</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/flyouting" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="http://weibo.com/flyouting" title="weibo">weibo</a>
			        
						<a class="zhihu" target="_blank" href="http://www.zhihu.com/people/flyouting" title="zhihu">zhihu</a>
			        
						<a class="mail" target="_blank" href="mailto:flyouting@gmail.com" title="mail">mail</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap">
  
    <article id="post-learn-python-the-hard-way-exercise52" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2014/12/04/learn-python-the-hard-way-exercise52/" class="article-date">
  	<time datetime="2014-12-04T13:43:57.000Z" itemprop="datePublished">2014-12-04</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/12/04/learn-python-the-hard-way-exercise52/">笨办法学Python--exercise52.开始你的web游戏</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>这本书马上就要结束了。本章的练习对你是一个真正的挑战。当你完成以后，你就可以算是一个能力不错的Python初学者了。为了进一步学习，你还需要多读一些书，多写一些程序，不过你已经具备进一步学习的技能了。接下来的学习就只是时间、动力、以及资源的问题了。</p>
<p>在本章习题中，我们不会去创建一个完整的游戏，取而代之的是我们会为《习题 47》中的游戏创建一个“引擎(engine)”，让这个游戏能够在浏览器中运行起来。这会涉及到将《习题 43》中的游戏“重构(refactor)”，将《习题 47》中的架构混合进来，添加自动测试代码，最后创建一个可以运行游戏的 web 引擎。</p>
<p>这是一节很庞大的习题。我预测你要花一周到一个月才能完成它。最好的方法是一点点来，每天晚上完成一点，在进行下一步之前确认上一步有正确完成。</p>
<h2 id="重构习题43的游戏"><a href="#重构习题43的游戏" class="headerlink" title="重构习题43的游戏"></a>重构习题43的游戏</h2><p>你已经在两个练习中修改了<code>gothonweb</code>项目，这节习题中你会再修改一次。这种修改的技术叫做“重构(refactoring)”，或者用我喜欢的讲法来说，叫“修修补补(fixing stuff)”。重构是一个编程术语，它指的是清理旧代码或者为旧代码添加新功能的过程。你其实已经做过这样的事情了，只不过不知道这个术语而已。这是写软件过程的第二个自然属性。</p>
<p>你在本节中要做的，是将《习题 47》中的可以测试的房间地图，以及《习题 43》中的游戏这两样东西归并到一起，创建一个新的游戏架构。游戏的内容不会变化，只不过我们会通过“重构”让它有一个更好的架构而已。</p>
<p>第一步是将<code>ex47/game.py</code>的内容复制到<code>gothonweb/map.py</code>中，然后将 <code>tests/ex47_tests.py</code>的内容复制到<code>tests/map_tests.py</code>中，然后再次运行 <code>nosetests</code>，确认他们还能正常工作。</p>
<blockquote>
<p><strong>NOTE:</strong><br>从现在开始我不会再向你展示运行测试的输出了，我就假设你回去运行这些测试，而且知道怎样的输出是正确的。</p>
</blockquote>
<p>将《习题 47》的代码拷贝完毕后，你就该开始重构它，让它包含《习题43》中的地图。我一开始会把基本架构为你准备好，然后你需要去完成<code>map.py</code> 和<code>map_tests.py</code>里边的内容。</p>
<p>首先要做的是使用<code>Room</code>类来构建基本的地图架构：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Room</span><span class="params">(object)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, description)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.description = description</span><br><span class="line">        self.paths = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">go</span><span class="params">(self, direction)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.paths.get(direction, <span class="keyword">None</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add_paths</span><span class="params">(self, paths)</span>:</span></span><br><span class="line">        self.paths.update(paths)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">central_corridor = Room(<span class="string">"Central Corridor"</span>,</span><br><span class="line"><span class="string">"""</span><br><span class="line">The Gothons of Planet Percal #25 have invaded your ship and destroyed</span><br><span class="line">your entire crew.  You are the last surviving member and your last</span><br><span class="line">mission is to get the neutron destruct bomb from the Weapons Armory,</span><br><span class="line">put it in the bridge, and blow the ship up after getting into an </span><br><span class="line">escape pod.</span><br><span class="line"></span><br><span class="line">You're running down the central corridor to the Weapons Armory when</span><br><span class="line">a Gothon jumps out, red scaly skin, dark grimy teeth, and evil clown costume</span><br><span class="line">flowing around his hate filled body.  He's blocking the door to the</span><br><span class="line">Armory and about to pull a weapon to blast you.</span><br><span class="line">"""</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">laser_weapon_armory = Room(<span class="string">"Laser Weapon Armory"</span>,</span><br><span class="line"><span class="string">"""</span><br><span class="line">Lucky for you they made you learn Gothon insults in the academy.</span><br><span class="line">You tell the one Gothon joke you know:</span><br><span class="line">Lbhe zbgure vf fb sng, jura fur fvgf nebhaq gur ubhfr, fur fvgf nebhaq gur ubhfr.</span><br><span class="line">The Gothon stops, tries not to laugh, then busts out laughing and can't move.</span><br><span class="line">While he's laughing you run up and shoot him square in the head</span><br><span class="line">putting him down, then jump through the Weapon Armory door.</span><br><span class="line"></span><br><span class="line">You do a dive roll into the Weapon Armory, crouch and scan the room</span><br><span class="line">for more Gothons that might be hiding.  It's dead quiet, too quiet.</span><br><span class="line">You stand up and run to the far side of the room and find the</span><br><span class="line">neutron bomb in its container.  There's a keypad lock on the box</span><br><span class="line">and you need the code to get the bomb out.  If you get the code</span><br><span class="line">wrong 10 times then the lock closes forever and you can't</span><br><span class="line">get the bomb.  The code is 3 digits.</span><br><span class="line">"""</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">the_bridge = Room(<span class="string">"The Bridge"</span>,</span><br><span class="line"><span class="string">"""</span><br><span class="line">The container clicks open and the seal breaks, letting gas out.</span><br><span class="line">You grab the neutron bomb and run as fast as you can to the</span><br><span class="line">bridge where you must place it in the right spot.</span><br><span class="line"></span><br><span class="line">You burst onto the Bridge with the netron destruct bomb</span><br><span class="line">under your arm and surprise 5 Gothons who are trying to</span><br><span class="line">take control of the ship.  Each of them has an even uglier</span><br><span class="line">clown costume than the last.  They haven't pulled their</span><br><span class="line">weapons out yet, as they see the active bomb under your</span><br><span class="line">arm and don't want to set it off.</span><br><span class="line">"""</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">escape_pod = Room(<span class="string">"Escape Pod"</span>,</span><br><span class="line"><span class="string">"""</span><br><span class="line">You point your blaster at the bomb under your arm</span><br><span class="line">and the Gothons put their hands up and start to sweat.</span><br><span class="line">You inch backward to the door, open it, and then carefully</span><br><span class="line">place the bomb on the floor, pointing your blaster at it.</span><br><span class="line">You then jump back through the door, punch the close button</span><br><span class="line">and blast the lock so the Gothons can't get out.</span><br><span class="line">Now that the bomb is placed you run to the escape pod to</span><br><span class="line">get off this tin can.</span><br><span class="line"></span><br><span class="line">You rush through the ship desperately trying to make it to</span><br><span class="line">the escape pod before the whole ship explodes.  It seems like</span><br><span class="line">hardly any Gothons are on the ship, so your run is clear of</span><br><span class="line">interference.  You get to the chamber with the escape pods, and</span><br><span class="line">now need to pick one to take.  Some of them could be damaged</span><br><span class="line">but you don't have time to look.  There's 5 pods, which one</span><br><span class="line">do you take?</span><br><span class="line">"""</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">the_end_winner = Room(<span class="string">"The End"</span>,</span><br><span class="line"><span class="string">"""</span><br><span class="line">You jump into pod 2 and hit the eject button.</span><br><span class="line">The pod easily slides out into space heading to</span><br><span class="line">the planet below.  As it flies to the planet, you look</span><br><span class="line">back and see your ship implode then explode like a</span><br><span class="line">bright star, taking out the Gothon ship at the same</span><br><span class="line">time.  You won!</span><br><span class="line">"""</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">the_end_loser = Room(<span class="string">"The End"</span>,</span><br><span class="line"><span class="string">"""</span><br><span class="line">You jump into a random pod and hit the eject button.</span><br><span class="line">The pod escapes out into the void of space, then</span><br><span class="line">implodes as the hull ruptures, crushing your body</span><br><span class="line">into jam jelly.</span><br><span class="line">"""</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">escape_pod.add_paths(&#123;</span><br><span class="line">    <span class="string">'2'</span>: the_end_winner,</span><br><span class="line">    <span class="string">'*'</span>: the_end_loser</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">generic_death = Room(<span class="string">"death"</span>, <span class="string">"You died."</span>)</span><br><span class="line"></span><br><span class="line">the_bridge.add_paths(&#123;</span><br><span class="line">    <span class="string">'throw the bomb'</span>: generic_death,</span><br><span class="line">    <span class="string">'slowly place the bomb'</span>: escape_pod</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">laser_weapon_armory.add_paths(&#123;</span><br><span class="line">    <span class="string">'0132'</span>: the_bridge,</span><br><span class="line">    <span class="string">'*'</span>: generic_death</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">central_corridor.add_paths(&#123;</span><br><span class="line">    <span class="string">'shoot!'</span>: generic_death,</span><br><span class="line">    <span class="string">'dodge!'</span>: generic_death,</span><br><span class="line">    <span class="string">'tell a joke'</span>: laser_weapon_armory</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">START = central_corridor</span><br></pre></td></tr></table></figure>
<p>你会发现我们的<code>Room</code>类和地图有一些问题：</p>
<blockquote>
<ol>
<li>在进入一个房间以前会打印出一段文字作为房间的描述，我们需要将这些描述和每个房间关联起来，这样房间的次序就不会被打乱了，这对我们的游戏是一件好事。这些描述本来是在<code>if-else</code>结构中的，这是我们后面要修改的东西。</li>
<li>原版游戏中我们使用了专门的代码来生成一些内容，例如炸弹的激活键码，舰舱的选择等，这次我们做游戏时就先使用默认值好了，不过后面的附加题里，我会要求你把这些功能再加到游戏中。</li>
<li>我为所有的游戏中的失败结尾写了一个<code>generic_death</code>，你需要去补全这个函数。你需要把原版游戏中所有的失败结尾都加进去，并确保代码能正确运行。</li>
<li>我添加了一种新的转换模式，以”*”为标记，用来在游戏引擎中实现“catch-all”动作。</li>
</ol>
</blockquote>
<p>等你把上面的代码基本写好以后，接下来就是引导你继续写下去的自动测试的内容<code>tests/map_test.py</code>了：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> nose.tools <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> gothonweb.map <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_room</span><span class="params">()</span>:</span></span><br><span class="line">    gold = Room(<span class="string">"GoldRoom"</span>,</span><br><span class="line">                <span class="string">"""This room has gold in it you can grab. There's a</span><br><span class="line">                door to the north."""</span>)</span><br><span class="line">    assert_equal(gold.name, <span class="string">"GoldRoom"</span>)</span><br><span class="line">    assert_equal(gold.paths, &#123;&#125;)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_room_paths</span><span class="params">()</span>:</span></span><br><span class="line">    center = Room(<span class="string">"Center"</span>, <span class="string">"Test room in the center."</span>)</span><br><span class="line">    north = Room(<span class="string">"North"</span>, <span class="string">"Test room in the north."</span>)</span><br><span class="line">    south = Room(<span class="string">"South"</span>, <span class="string">"Test room in the south."</span>)</span><br><span class="line"></span><br><span class="line">    center.add_paths(&#123;<span class="string">'north'</span>: north, <span class="string">'south'</span>: south&#125;)</span><br><span class="line">    assert_equal(center.go(<span class="string">'north'</span>), north)</span><br><span class="line">    assert_equal(center.go(<span class="string">'south'</span>), south)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_map</span><span class="params">()</span>:</span></span><br><span class="line">    start = Room(<span class="string">"Start"</span>, <span class="string">"You can go west and down a hole."</span>)</span><br><span class="line">    west = Room(<span class="string">"Trees"</span>, <span class="string">"There are trees here, you can go east."</span>)</span><br><span class="line">    down = Room(<span class="string">"Dungeon"</span>, <span class="string">"It's dark down here, you can go up."</span>)</span><br><span class="line"></span><br><span class="line">    start.add_paths(&#123;<span class="string">'west'</span>: west, <span class="string">'down'</span>: down&#125;)</span><br><span class="line">    west.add_paths(&#123;<span class="string">'east'</span>: start&#125;)</span><br><span class="line">    down.add_paths(&#123;<span class="string">'up'</span>: start&#125;)</span><br><span class="line"></span><br><span class="line">    assert_equal(start.go(<span class="string">'west'</span>), west)</span><br><span class="line">    assert_equal(start.go(<span class="string">'west'</span>).go(<span class="string">'east'</span>), start)</span><br><span class="line">    assert_equal(start.go(<span class="string">'down'</span>).go(<span class="string">'up'</span>), start)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_gothon_game_map</span><span class="params">()</span>:</span></span><br><span class="line">    assert_equal(START.go(<span class="string">'shoot!'</span>), generic_death)</span><br><span class="line">    assert_equal(START.go(<span class="string">'dodge!'</span>), generic_death)</span><br><span class="line"></span><br><span class="line">    room = START.go(<span class="string">'tell a joke'</span>)</span><br><span class="line">    assert_equal(room, laser_weapon_armory)</span><br></pre></td></tr></table></figure>
<p>你在这部分练习中的任务是完成地图，并且让自动测试可以完整地检查过整个地图。这包括将所有的<code>generic_death</code>对象修正为游戏中实际的失败结尾。让你的代码成功运行起来，并让你的测试越全面越好。后面我们会对地图做一些修改，到时候这些测试将保证修改后的代码还可以正常工作。</p>
<h2 id="会话-session-和用户跟踪"><a href="#会话-session-和用户跟踪" class="headerlink" title="会话(session)和用户跟踪"></a>会话(session)和用户跟踪</h2><p>在你的 web 程序运行的某个位置，你需要追踪一些信息，并将这些信息和用户的浏览器关联起来。在HTTP协议的框架中，web环境是“无状态(stateless)”的，这意味着你的每一次请求都是独立于其他请求的。如果你请求了页面A，输入了一些数据，然后点了一个页面B的链接，那你在页面A输入的数据就全部消失了。</p>
<p>解决这个问题的方法是为 web 程序建立一个很小的数据存储功能，给每个浏览器进程赋予一个独一无二的数字，用来跟踪浏览器所作的事情。这个存储通常用数据库或者存储在磁盘上的文件来实现。这就是所谓的“会话跟踪”和在浏览器中使用Cookies以保持用户状态。在<code>lpthw.web</code>这个小框架中实现这样的功能是很容易的，以下就是一个这样的例子：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> web</span><br><span class="line"></span><br><span class="line">web.config.debug = <span class="keyword">False</span></span><br><span class="line"></span><br><span class="line">urls = (</span><br><span class="line">    <span class="string">"/count"</span>, <span class="string">"count"</span>,</span><br><span class="line">    <span class="string">"/reset"</span>, <span class="string">"reset"</span></span><br><span class="line">)</span><br><span class="line">app = web.application(urls, locals())</span><br><span class="line">store = web.session.DiskStore(<span class="string">'sessions'</span>)</span><br><span class="line">session = web.session.Session(app, store, initializer=&#123;<span class="string">'count'</span>: <span class="number">0</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">count</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">GET</span><span class="params">(self)</span>:</span></span><br><span class="line">        session.count += <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> str(session.count)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">reset</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">GET</span><span class="params">(self)</span>:</span></span><br><span class="line">        session.kill()</span><br><span class="line">        <span class="keyword">return</span> <span class="string">""</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure>
<p>为了实现这个功能，你需要创建一个<code>sessions/</code>文件夹作为程序的会话存储位置，创建好以后运行这个程序，然后检查<code>/count</code>页面，刷新一下这个页面，看计数会不会累加上去。关掉浏览器后，程序就会“忘掉”之前的位置，这也是我们的游戏所需的功能。有一种方法可以让浏览器永远记住一些信息，不过这会让测试和开发变得更难。如果你回到<code>/reset/</code>页面，然后再访问<code>/count</code> 页面，你可以看到你的计数器被重置了，因为你已经把会话杀掉了。</p>
<p>你需要花点时间弄懂这段代码，注意会话开始时 <code>count</code>的值是如何设为 0 的。另外再看看 <code>sessions/</code>下面的文件，看你能不能把它们打开。下面是我把一个 Python 会话打开并且解码的过程：</p>
<pre><code>&gt;&gt;&gt; import pickle
&gt;&gt;&gt; import base64
&gt;&gt;&gt; base64.b64decode(open(&quot;sessions/XXXXX&quot;).read())
&quot;(dp1\nS&apos;count&apos;\np2\nI1\nsS&apos;ip&apos;\np3\nV127.0.0.1\np4\nsS&apos;session_id&apos;\np5\nS&apos;XXXX&apos;\np6\ns.&quot;
&gt;&gt;&gt;
&gt;&gt;&gt; x = base64.b64decode(open(&quot;sessions/XXXXX&quot;).read())
&gt;&gt;&gt;
&gt;&gt;&gt; pickle.loads(x)
{&apos;count&apos;: 1, &apos;ip&apos;: u&apos;127.0.0.1&apos;, &apos;session_id&apos;: &apos;XXXXX&apos;}
</code></pre><p>所以会话其实就是使用<code>pickle</code>和<code>base64</code>这些库写到磁盘上的字典。存储和管理会话的方法很多，大概和 Python 的 web 框架那么多，所以了解它们的工作原理并不重要。当然如果你需要调试或者清空会话时，知道点原理还是有用的。</p>
<h2 id="创建引擎"><a href="#创建引擎" class="headerlink" title="创建引擎"></a>创建引擎</h2><p>你应该已经写好了游戏地图和它的单元测试代码。现在我要求你制作一个简单的游戏引擎，用来让游戏中的各个房间运转起来，从玩家收集输入，并且记住玩家到了那一幕。我们将用到你刚学过的会话来制作一个简单的引擎，让它可以：</p>
<blockquote>
<ol>
<li>为新用户启动新的游戏。</li>
<li>将房间展示给用户。</li>
<li>接受用户的输入。</li>
<li>在游戏中处理用户的输入。</li>
<li>显示游戏的结果，继续游戏的下一幕，知道玩家角色死亡为止.</li>
</ol>
</blockquote>
<p>为了创建这个引擎，你需要将我们久经考验的<code>bin/app.py</code>搬过来，创建一个功能完备的、基于会话的游戏引擎。这里的难点是我会先使用基本的 HTML 文件创建一个非常简单的版本，接下来将由你完成它，基本的引擎是这个样子的：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> web</span><br><span class="line"><span class="keyword">from</span> gothonweb <span class="keyword">import</span> map</span><br><span class="line"></span><br><span class="line">urls = (</span><br><span class="line">  <span class="string">'/game'</span>, <span class="string">'GameEngine'</span>,</span><br><span class="line">  <span class="string">'/'</span>, <span class="string">'Index'</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">app = web.application(urls, globals())</span><br><span class="line"></span><br><span class="line"><span class="comment"># little hack so that debug mode works with sessions</span></span><br><span class="line"><span class="keyword">if</span> web.config.get(<span class="string">'_session'</span>) <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">    store = web.session.DiskStore(<span class="string">'sessions'</span>)</span><br><span class="line">    session = web.session.Session(app, store,</span><br><span class="line">                                  initializer=&#123;<span class="string">'room'</span>: <span class="keyword">None</span>&#125;)</span><br><span class="line">    web.config._session = session</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    session = web.config._session</span><br><span class="line"></span><br><span class="line">render = web.template.render(<span class="string">'templates/'</span>, base=<span class="string">"layout"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Index</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">GET</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># this is used to "setup" the session with starting values</span></span><br><span class="line">        session.room = map.START</span><br><span class="line">        web.seeother(<span class="string">"/game"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GameEngine</span><span class="params">(object)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">GET</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> session.room:</span><br><span class="line">            <span class="keyword">return</span> render.show_room(room=session.room)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># why is there here? do you need it?</span></span><br><span class="line">            <span class="keyword">return</span> render.you_died()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">POST</span><span class="params">(self)</span>:</span></span><br><span class="line">        form = web.input(action=<span class="keyword">None</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># there is a bug here, can you fix it?</span></span><br><span class="line">        <span class="keyword">if</span> session.room <span class="keyword">and</span> form.action:</span><br><span class="line">            session.room = session.room.go(form.action)</span><br><span class="line"></span><br><span class="line">        web.seeother(<span class="string">"/game"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure></p>
<p>这个脚本里你可以看到更多的新东西，不过了不起的事情是，整个基于网页的游戏引擎只要一个小文件就可以做到了。这段脚本里最有技术含量的事情就是将会话带回来的那几行，这对于调试模式下的代码重载是必须的，否则每次你刷新网页，会话就会消失，游戏也不会再继续了。</p>
<p>在你运行<code>bin/app.py</code>之前，你需要修改<code>PYTHONPATH</code>环境变量。不知道什么是环境变量？为了运行一个最基本的 Python 程序，你就得学会环境变量，Python 的这一点确实有点挫。不过没办法，用 Python 的人就喜欢这样：<br>在你的命令行终端，输入:</p>
<pre><code>export PYTHONPATH=$PYTHONPATH:.
</code></pre><p>如果你用的是 Windows，那就输入:</p>
<pre><code>$env:PYTHONPATH = &quot;$env:PYTHONPATH;.&quot;
</code></pre><p>你只要针对每一个命令行会话界面输入一次就可以了，不过如果你运行 Python 代码时看到了import错误，那你就需要去执行一下上面的命令，或者也许是因为你上次执行的 有错才导致 import 错误的。</p>
<p>接下来你需要删掉<code>templates/hello_form.html</code>和 <code>templates/index.html</code>，然后重新创建上面代码中提到的两个模板。这里是一个非常简单的 <code>templates/show_room.html</code> 供你参考：</p>
<pre><code>$def with (room)

&lt;h1&gt; $room.name &lt;/h1&gt;

&lt;pre&gt;
$room.description
&lt;/pre&gt;

$if room.name == &quot;death&quot;:
    &lt;p&gt;&lt;a href=&quot;/&quot;&gt;Play Again?&lt;/a&gt;&lt;/p&gt;
$else:
    &lt;p&gt;
    &lt;form action=&quot;/game&quot; method=&quot;POST&quot;&gt;
        - &lt;input type=&quot;text&quot; name=&quot;action&quot;&gt; &lt;input type=&quot;SUBMIT&quot;&gt;
    &lt;/form&gt;
    &lt;/p&gt;
</code></pre><p>这就用来显示游戏中的房间的模板。接下来，你需要在用户跑到地图的边界时，用一个 模板告诉用户他的角色的死亡信息，也就是 <code>templates/you_died.html</code> 这个模板：</p>
<pre><code>&lt;h1&gt;You Died!&lt;/h1&gt;

&lt;p&gt;Looks like you bit the dust.&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;/&quot;&gt;Play Again&lt;/a&gt;&lt;/p&gt;
</code></pre><p>准备好了这些文件，你现在可以做下面的事情了：</p>
<blockquote>
<ol>
<li>让测试代码 <code>tests/app_tests.py</code> 再次运行起来，这样你就可以去测试这个游戏。由于会话的存在，你可能顶多只能实现几次点击，不过你应该可以做出一些基本的测试来。</li>
<li>删除 <code>sessions/*</code>下的文件，再重新运行一遍游戏，确认游戏是从一开始运行起来的。</li>
<li>执行 <code>python bin/app.py</code> 脚本，试玩一下你的游戏。</li>
</ol>
</blockquote>
<p>你需要和往常一样刷新和修正你的游戏，慢慢修改游戏的 HTML 文件和引擎，直到你实现游戏需要的所有功能为止。</p>
<h2 id="你的期末考试"><a href="#你的期末考试" class="headerlink" title="你的期末考试"></a>你的期末考试</h2><p>你有没有觉着我一下子给了你超多的信息呢？那就对了，我想要你在学习技能的同时可以有一些可以用来鼓捣的东西。为了完成这节习题，我将给你最后一套需要你自己完成的练习。你将注意到，到目前为止你写的游戏并不是很好，这只是你的第一版代码而已。你现在的任务是通过做这些事让游戏更加完善：</p>
<blockquote>
<ol>
<li>修正代码中所有我提到和没提到的 bug，如果你发现了新的 bug，你可以告诉我。</li>
<li>改进所有的自动测试，让你可以测试更多的内容，直到你可以不用浏览器就能测到所有的内容为止。</li>
<li>让 HTML 页面看上去更美观一些。</li>
<li>研究一下网页登录系统，为这个程序创建一个登录界面，这样人们就可以登录这个游戏，并且可以保存游戏高分。</li>
<li>完成游戏地图，尽可能地把游戏做大，功能做全。</li>
<li>给用户一个“帮助系统”，让他们可以查询每个房间里可以执行哪些命令。</li>
<li>为你的游戏添加新功能，想到什么功能就添加什么功能。</li>
<li>创建多个地图，让用户可以选择他们想要玩的一张来进行游戏。你的 <code>bin/app.py</code> 应该可以运行提供给它的任意的地图，这样你的引擎就可以支持多个不同的游戏。</li>
<li>最后，使用你在习题 48 和 49 中学到的东西来创建一个更好的输入处理器。你手头已经有了大部分必要的代码，你只需要改进语法，让它和你的输入表单以及游戏引擎挂钩即可。</li>
</ol>
</blockquote>
<p>祝你好运！</p>
<h2 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h2><h3 id="Q-我在游戏中使用了sessions，但是我没办法利用nosetests来测试它"><a href="#Q-我在游戏中使用了sessions，但是我没办法利用nosetests来测试它" class="headerlink" title="Q: 我在游戏中使用了sessions，但是我没办法利用nosetests来测试它"></a>Q: 我在游戏中使用了<code>sessions</code>，但是我没办法利用<code>nosetests</code>来测试它</h3><blockquote>
<p>你需要了解sessions的机制。<code>http://webpy.org/cookbook/session_with_reloader</code>。</p>
</blockquote>
<h3 id="Q-我遇到报错ImportError"><a href="#Q-我遇到报错ImportError" class="headerlink" title="Q: 我遇到报错ImportError"></a>Q: 我遇到报错<code>ImportError</code></h3><blockquote>
<p> 错误的目录。 错误的Python版本。 <code>PYTHONPATH</code>没有设置，没有<code>__init__.py</code>文件，检查<code>import</code>中的拼写错误。</p>
</blockquote>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/python/">python</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Python/">Python</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-learn-python-the-hard-way-exercise51" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2014/12/03/learn-python-the-hard-way-exercise51/" class="article-date">
  	<time datetime="2014-12-03T13:09:57.000Z" itemprop="datePublished">2014-12-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/12/03/learn-python-the-hard-way-exercise51/">笨办法学Python--exercise51.从浏览器获取输入</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>虽然能让浏览器显示“Hello World”是很有趣的一件事情，但是如果能让用户通过表单(form)向你的应用程序提交文本就更有趣了。这节习题中，我们将使用 form 改进你的 web 程序，并且将用户相关的信息保存到他们的“会话(session)”中。</p>
<h2 id="Web-的工作原理"><a href="#Web-的工作原理" class="headerlink" title="Web 的工作原理"></a>Web 的工作原理</h2><p>该学点无趣的东西了。在创建 form 前你需要先多学一点关于 web的工作原理。这里讲的并不完整，但是相当准确，在你的程序出错时，它会帮你找到出错的原因。另外，如果你理解了 form 的应用，那么创建 form 对你来说就会更容易了。</p>
<p>我将以一个简单的图示讲起，它向你展示了 web 请求的各个不同的部分，以及信息传递的大致流程：</p>
<p><img src="http://ww4.sinaimg.cn/bmiddle/5dcbe385gw1emvdejnwllj20c806g74i.jpg" alt=""></p>
<p>为了方便讲述 HTTP 请求(request) 的流程，我在每条线上面加了字母标签以作区别：</p>
<blockquote>
<ol>
<li>你在浏览器中输入网址<code>http://test.com//</code>，然后浏览器会通过你的电脑的网络设备发出 request（线路 A）。</li>
<li>你的 request 被传送到互联网（线路B），然后再抵达远端服务器（线路 C），然后我的服务器将接受这个 request。</li>
<li>我的服务器接受 request 后，我的web应用程序就去处理这个请求（线路 D），然后我的 Python代码就会去运行<code>index.GET</code>这个“处理程序(handler)”。</li>
<li>在代码<code>return</code> 的时候，我的 Python 服务器就会发出响应(response)，这个响应会再通过线路 D 传递到你的浏览器。</li>
<li>这个网站所在的服务器将响应由线路 D 获取，然后通过线路 C 传至互联网。</li>
<li>响应通过互联网由线路 B 传至你的计算机，计算机的网卡再通过线路 A 将响应传给你的浏览器。</li>
<li>最后，你的浏览器显示了这个响应的内容。</li>
</ol>
</blockquote>
<p>这段解释中用到了一些术语。你需要掌握这些术语，以便在谈论你的 web 应用时你能明白而且应用它们：</p>
<p>浏览器(browser)<br>这是你几乎每天都会用到的软件。大部分人不知道它真正的原理，他们只会把它叫作“the internet”。它的作用其实是接收你输入到地址栏网址(例如 <code>http://test.com/</code>)，然后使用该信息向该网址对应的服务器提出请求(request)。</p>
<p>地址(address)<br>通常这是一个像<code>http://test.com/</code>一样的 URL (Uniform Resource Locator，统一资源定位器)，它告诉浏览器该打开哪个网站。前面的<code>http</code> 指出了你要使用的协议(protocol)，这里我们用的是“超文本传输协议(Hyper-Text Transport Protocol)”。你还可以试试<code>ftp://ibiblio.org/</code> ，这是一个“FTP 文件传输协议(File Transport Protocol)”的例子。<code>test.com</code> 这部分是“主机名(hostname)”，也就是一个便于人阅读和记忆的字串，主机名会被匹配到一串叫作“IP 地址”的数字上面，这个“IP 地址”就相当于网络中一台计算机的电话号码，通过这个号码可以访问到这台计算机。最后，URL 中还可以尾随一个“路径”，例如 <code>http://test.com//book/</code>中的<code>/book/</code>，它对应的是服务器上的某个文件或者某些资源，通过访问这样的网址，你可以向服务器发出请求，然后获得这些资源。网站地址还有很多别的组成部分，不过这些是最主要的。</p>
<p>连接(connection)<br>一旦浏览器知道了协议(http)、服务器(<code>http://test.com/</code>)、以及要获得的资源，它就要去创建一个连接。这个过程中，浏览器让操作系统(Operating System, OS)打开计算机的一个“端口(port)”（通常是 80 端口），端口准备好以后，操作系统会回传给你的程序一个类似文件的东西，它所做的事情就是通过网络传输和接收数据，让你的计算机和 <code>http://test.com/</code>这个网站所属的服务器之间实现数据交流。 当你使用 <code>http://localhost:8080/</code>访问你自己的站点时，发生的事情其实是一样的，只不过这次你告诉了浏览器要访问的是你自己的计算机(localhost)，要使用的端口 不是默认的 80，而是 8080。你还可以直接访问 <code>http://test.com:80/</code>， 这和不输入端口效果一样，因为 HTTP 的默认端口本来就是 80。</p>
<p>请求(request)<br>你的浏览器通过你提供的地址建立了连接，现在它需要从远端服务器要到它（或你）想要的资源。如果你在 URL 的结尾加了 <code>/book/</code>，那你想要的就是 <code>/book/</code> 对应的文件或资源，大部分的服务器会直接为你调用 <code>/book/index.html</code>这个文件，不过我们就假装不存在好了。浏览器为了获得服务器上的资源，它需要向服务器发送一个“请求”。这里我就不讲细节了，为了得到服务器上的内容，你必须先向服务器发送一个请求才行。有意思的是，“资源”不一定非要是文件。例如当浏览器向你的应用程序提出请求的时候，服务器返回的其实是你的 Python 代码生成的一些东西。</p>
<p>服务器(server)<br>服务器指的是浏览器另一端连接的计算机，它知道如何回应浏览器请求的文件和资源。大部分的 web 服务器只要发送文件就可以了，这也是服务器流量的主要部分。不过你学的是使用 Python 组建一个服务器，这个服务器知道如何接受请求，然后返回用 Python 处理过的字符串。当你使用这种处理方式时，你其实是假装把文件发给了浏览器，其实你用的都只是代码而已。就像你在《习题50》中看到的，要构建一个“响应”其实也不需要多少代码。</p>
<p>响应(response)<br>这就是你的服务器回复你的请求，发回至浏览器的 HTML，它里边可能有 css、javascript、或者图像等内容。以文件响应为例，服务器只要从磁盘读取文件，发送给浏览器就可以了，不过它还要将这些内容包在一个特别定义的“头部信息(header)”中，这样浏览器就会知道它获取的是什么类型的内容。以你的 web 应用程序为例，你发送的其实还是一样的东西，包括 header 也一样，只不过这些数据是你用 Python 代码即时生成的。</p>
<p>这个可能是你能在网上找到的关于浏览器如何访问网站的最快的快速课程了。这节课程应该可以帮你更容易地理解本节的习题，如果你还是不明白，就到处找资料多多了解这方面的信息，直到你明白为止。有一个很好的方法，就是你对照着上面的图示，将你在《习题 50》中创建的 web 程序中的内容分成几个部分，让其中的各部分对应到上面的图示。如果你可以正确地将程序的各部分对应到这个图示，你就大致明白它的工作原理了。</p>
<h2 id="表单-form-的工作原理"><a href="#表单-form-的工作原理" class="headerlink" title="表单(form) 的工作原理"></a>表单(form) 的工作原理</h2><p>熟悉“表单”最好的方法就是写一个可以接收表单数据的程序出来，然后看你可以对它做些什么。先将你的<code>bin/app.py</code>修改成下面的样子：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> web</span><br><span class="line"></span><br><span class="line">urls = (</span><br><span class="line">  <span class="string">'/hello'</span>, <span class="string">'Index'</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app = web.application(urls, globals())</span><br><span class="line"></span><br><span class="line">render = web.template.render(<span class="string">'templates/'</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Index</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">GET</span><span class="params">(self)</span>:</span></span><br><span class="line">        form = web.input(name=<span class="string">"Nobody"</span>)</span><br><span class="line">        greeting = <span class="string">"Hello, %s"</span> % form.name</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> render.index(greeting = greeting)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure>
<p>重启你的 web 程序（按 CTRL-C 后重新运行），确认它有运行起来，然后使用浏览器访问 <code>http://localhost:8080/hello</code>，这时浏览器应该会显示“I just wanted to say Hello, Nobody.”，接下来，将浏览器的地址改成 <code>http://localhost:8080/hello?name=Frank</code>，然后你可以看到页面显示为“Hello, Frank.”，最后将 <code>name=Frank</code> 修改为你自己的名字，你就可以看到它对你说“Hello”了。</p>
<p>让我们研究一下你的程序里做过的修改:</p>
<blockquote>
<ol>
<li>我们没有直接为<code>greeting</code>赋值，而是使用了<code>web.input</code> 从浏览器获取数据。这个函数会将一组 key=value 的表述作为默认参数，解析你提供的 URL 中的<code>?name=Frank</code> 部分，然后返回一个对象，你可以通过这个对象方便地访问到表单的值。</li>
<li>然后我通过<code>form</code>对象的<code>form.name</code>属性为<code>greeting</code>赋值，这句你应该已经熟悉了。</li>
<li>其他的内容和以前是一样的。</li>
</ol>
</blockquote>
<p>URL 中该还可以包含多个参数。将本例的 URL 改成这样子： <code>http://localhost:8080/hello?name=Frank&amp;greet=Hola</code>。然后修改代码，让它去获取<code>form.name</code>和<code>form.greet</code>，如下所示：</p>
<pre><code>greeting = &quot;%s, %s&quot; % (form.greet, form.name)
</code></pre><p>修改完毕后，试着访问新的 URL。然后将 <code>&amp;greet=Hola</code> 部分删除，看看你会得到什么样的错误信息。由于我们在 <code>web.input(name=&quot;Nobody&quot;)</code> 中没有为 <code>greet</code> 设定默认值，这样 <code>greet</code> 就变成了一个必须的参数，如果没有这个参数程序就会报错。现在修改一下你的程序，在 <code>web.input</code> 中为 <code>greet</code> 设一个默认值试试看。另外你还可以设 greet=None，这样你可以通过程序检查 <code>greet</code> 的值是否存在，然后提供一个比较好的错误信息出来，例如：</p>
<pre><code>form = web.input(name=&quot;Nobody&quot;, greet=None)

if form.greet:
    greeting = &quot;%s, %s&quot; % (form.greet, form.name)
    return render.index(greeting = greeting)
else:
    return &quot;ERROR: greet is required.&quot;
</code></pre><h2 id="创建-HTML-表单"><a href="#创建-HTML-表单" class="headerlink" title="创建 HTML 表单"></a>创建 HTML 表单</h2><p>你可以通过 URL 参数实现表单提交，不过这样看上去有些丑陋，而且不方便一般人使用，你真正需要的是一个“POST 表单”，这是一种包含了<code>&lt;form&gt;</code> 标签的特殊 HTML 文件。这种表单收集用户输入并将其传递给你的 web 程序，这和你上面实现的目的基本是一样的。</p>
<p>让我们来快速创建一个，从中你可以看出它的工作原理。你需要创建一个新的 HTML 文件， 叫做<code>templates/hello_form.html</code>：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">title</span>&gt;</span>Sample Web Form<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Fill Out This Form<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"/hello"</span> <span class="attr">method</span>=<span class="string">"POST"</span>&gt;</span></span><br><span class="line">    A Greeting: <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"greet"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">    Your Name: <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"name"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>然后修改<code>bin/app.py</code>:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> web</span><br><span class="line"></span><br><span class="line">urls = (</span><br><span class="line">  <span class="string">'/hello'</span>, <span class="string">'Index'</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">app = web.application(urls, globals())</span><br><span class="line"></span><br><span class="line">render = web.template.render(<span class="string">'templates/'</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Index</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">GET</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> render.hello_form()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">POST</span><span class="params">(self)</span>:</span></span><br><span class="line">        form = web.input(name=<span class="string">"Nobody"</span>, greet=<span class="string">"Hello"</span>)</span><br><span class="line">        greeting = <span class="string">"%s, %s"</span> % (form.greet, form.name)</span><br><span class="line">        <span class="keyword">return</span> render.index(greeting = greeting)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure>
<p>都写好以后，重启 web 程序，然后通过你的浏览器访问它。</p>
<p>这回你会看到一个表单，它要求你输入“一个问候语句(A Greeting)”和“你的名字(Your Name)”，等你输入完后点击“提交(Submit)”按钮，它就会输出一个正常的问候页面，不过这一次你的URL 还是<code>http://localhost:8080/hello</code>，并没有添加参数进去。</p>
<p>在 <code>hello_form.html</code>里面关键的一行是 <code>&lt;form action=&quot;/hello&quot; method=&quot;POST&quot;&gt;</code>，它告诉你的浏览器以下内容：</p>
<blockquote>
<ol>
<li>从表单中的各个栏位收集用户输入的数据。</li>
<li>让浏览器使用一种<code>POST</code>类型的请求，将这些数据发送给服务器。这是另外一种浏览器请求，它会将表单栏位“隐藏”起来。</li>
<li>将这个请求发送至<code>/hello</code>URL(这是由<code>action=&quot;/hello&quot;</code>告诉浏览器的)。</li>
</ol>
</blockquote>
<p>你可以看到两段<code>&lt;input&gt;</code> 标签的名字属性(name)和代码中的变量是对应的，另外我们在<code>class index</code> 中使用的不再只是<code>GET</code>方法，而是另一个<code>POST</code>方法。</p>
<p>这个新程序的工作原理如下：</p>
<blockquote>
<ol>
<li>浏览器访问到 web 程序的 <code>/hello</code> 目录，它发送了一个<code>GET</code> 请求，于是我们的 <code>index.GET</code> 函数就运行并返回了 <code>hello_form</code>。</li>
<li>你填好了浏览器的表单，然后浏览器依照<code>&lt;form&gt;</code>中的要求，将数据通过 <code>POST</code> 请求的方式发给 web 程序。</li>
<li>Web 程序运行了 <code>index.POST</code> 方法（不是 <code>index.GET</code> 方法）来处理这个请求。</li>
<li>这个 <code>index.POST</code> 方法完成了它正常的功能，将 hello 页面返回，这里并没有新的东西，只是一个新函数名称而已。</li>
</ol>
</blockquote>
<p>作为练习，在 <code>templates/index.html</code> 中添加一个链接，让它指向 <code>/hello</code>，这样你可以反复填写并提交表单查看结果。确认你可以解释清楚这个链接的工作原理，以及它是如何让你实现在 <code>templates/index.html</code> 和 <code>templates/hello_form.html</code> 之间循环跳转的，还有就是要明白你新修改过的 Python 代码，你需要知道在什么情况下会运行到哪一部分代码。</p>
<h2 id="创建布局模板-layout-template"><a href="#创建布局模板-layout-template" class="headerlink" title="创建布局模板(layout template)"></a>创建布局模板(layout template)</h2><p>在你下一节练习创建游戏的过程中，你需要创建很多的小 HTML 页面。如果你每次都写一个完整的网页，你会很快感觉到厌烦的。幸运的 是你可以创建一个“布局模板”，也就是一种提供了通用的头文件和脚注的外壳模板，你可以用它将你所有的其他网页包裹起来。好程序员会尽可能减少重复动作，所以要做一个好程序员，使用布局模板是很重要的。</p>
<p>将 <code>templates/index.html</code> 修改成这样：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$def with (greeting)</span><br><span class="line"></span><br><span class="line">$if greeting:</span><br><span class="line">    I just wanted to say <span class="tag">&lt;<span class="name">em</span> <span class="attr">style</span>=<span class="string">"color: green; font-size: 2em;"</span>&gt;</span>$greeting<span class="tag">&lt;/<span class="name">em</span>&gt;</span>.</span><br><span class="line">$else:</span><br><span class="line">    <span class="tag">&lt;<span class="name">em</span>&gt;</span>Hello<span class="tag">&lt;/<span class="name">em</span>&gt;</span>, world!</span><br></pre></td></tr></table></figure></p>
<p>然后修改 <code>templates/hello_form.html</code>:<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Fill Out This Form<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"/hello"</span> <span class="attr">method</span>=<span class="string">"POST"</span>&gt;</span></span><br><span class="line">    A Greeting: <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"greet"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">    Your Name: <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"name"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>上面这些修改的目的，是将每一个页面顶部和底部的反复用到的“boilerplate”代码剥掉。这些被剥掉的代码会被放到一个单独的<code>templates/layout.html</code> 文件中，从此以后，这些反复用到的代码就由<code>layout.html</code> 来提供了。</p>
<p>上面的都改好以后，创建一个<code>templates/layout.html</code>文件，内容如下：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$def with (content)</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Gothons From Planet Percal #25<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line">$:content</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>这个文件和普通的模板文件类似，不过其它的模板的内容将被传递给它，然后它会将其它 模板的内容“包裹”起来。任何写在这里的内容多无需写在别的模板中了。你需要注意<code>$:content</code> 的用法，这和其它的模板变量有些不同。</p>
<p>最后一步，就是将<code>render</code> 对象改成这样：<br>    render = web.template.render(‘templates/‘, base=”layout”)</p>
<p>这会告诉<code>lpthw.web</code>让它去使用<code>templates/layout.html</code> 作为其它模板的基础模板。重启你的程序观察一下，然后试着用各种方法修改你的 layout 模板，不要修改你别的模板，看看输出会有什么样的变化。</p>
<h2 id="为表单撰写自动测试代码"><a href="#为表单撰写自动测试代码" class="headerlink" title="为表单撰写自动测试代码"></a>为表单撰写自动测试代码</h2><p>使用浏览器测试 web 程序是很容易的，只要点刷新按钮就可以了。不过毕竟我们是程序员嘛，如果我们可以写一些代码来测试我们的程序，为什么还要重复手动测试呢？接下来你要做的，就是为你的 web 程序写一个小测试。这会用到你在《习题 47》学过的一些东西，如果你不记得的话，可以复习一下。</p>
<p>为了让 Python 加载 <code>bin/app.py</code>  并进行测试，你需要先做一点准备工作。首先创建一个 <code>bin/__init__.py</code> 空文件，这样 Python 就会将 <code>bin/</code> 当作一个目录了。（在《习题 52》中你会去修改 <code>__init__.py</code>，不过这是后话。）</p>
<p>我还为 <code>lpthw.web</code> 创建了一个简单的小函数，让你判断(assert) web 程序的响应，这个函数的名字，叫 <code>assert_response</code>。创建一个 <code>tests/tools.py</code> 文件，内容如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> nose.tools <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">assert_response</span><span class="params">(resp, contains=None, matches=None, headers=None, status=<span class="string">"200"</span>)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">assert</span> status <span class="keyword">in</span> resp.status, <span class="string">"Expected response %r not in %r"</span> % (status, resp.status)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> status == <span class="string">"200"</span>:</span><br><span class="line">        <span class="keyword">assert</span> resp.data, <span class="string">"Response data is empty."</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> contains:</span><br><span class="line">        <span class="keyword">assert</span> contains <span class="keyword">in</span> resp.data, <span class="string">"Response does not contain %r"</span> % contains</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> matches:</span><br><span class="line">        reg = re.compile(matches)</span><br><span class="line">        <span class="keyword">assert</span> reg.matches(resp.data), <span class="string">"Response does not match %r"</span> % matches</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> headers:</span><br><span class="line">        assert_equal(resp.headers, headers)</span><br></pre></td></tr></table></figure></p>
<p>准备好这个文件以后，你就可以为你的<code>bin/app.py</code>写自动测试代码了。创建一个新文件，叫做 <code>tests/app_tests.py</code>，内容如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> nose.tools <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> bin.app <span class="keyword">import</span> app</span><br><span class="line"><span class="keyword">from</span> tests.tools <span class="keyword">import</span> assert_response</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_index</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># check that we get a 404 on the / URL</span></span><br><span class="line">    resp = app.request(<span class="string">"/"</span>)</span><br><span class="line">    assert_response(resp, status=<span class="string">"404"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># test our first GET request to /hello</span></span><br><span class="line">    resp = app.request(<span class="string">"/hello"</span>)</span><br><span class="line">    assert_response(resp)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># make sure default values work for the form</span></span><br><span class="line">    resp = app.request(<span class="string">"/hello"</span>, method=<span class="string">"POST"</span>)</span><br><span class="line">    assert_response(resp, contains=<span class="string">"Nobody"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># test that we get expected values</span></span><br><span class="line">    data = &#123;<span class="string">'name'</span>: <span class="string">'Zed'</span>, <span class="string">'greet'</span>: <span class="string">'Hola'</span>&#125;</span><br><span class="line">    resp = app.request(<span class="string">"/hello"</span>, method=<span class="string">"POST"</span>, data=data)</span><br><span class="line">    assert_response(resp, contains=<span class="string">"Zed"</span>)</span><br></pre></td></tr></table></figure>
<p>最后，使用<code>nosetests</code>运行测试脚本，然后测试你的 web 程序。</p>
<pre><code>$ nosetests
.
----------------------------------------------------------------------
Ran 1 test in 0.059s

OK
</code></pre><p>这里我所做的，是将 <code>bin/app.py</code>这个模块中的整个 web 程序都 import 进来，然后手动运行这个 web 程序。<code>lpthw.web</code> 有一个非常简单的 API 用来处理请求，看上去大致是这样子的：</p>
<pre><code>app.request(localpart=&apos;/&apos;, method=&apos;GET&apos;, data=None, host=&apos;0.0.0.0:8080&apos;,
            headers=None, https=False)
</code></pre><p>你可以将 URL 作为第一个参数，然后你可以修改 request 的方法、form 的数据、以及 header 的内容，这样你无须启动 web 服务器，就可以使用自动测试来测试你的 web 程序了。</p>
<p>为了验证函数的响应，你需要使用<code>tests.tools</code>中定义的<code>assert_response</code> 函数，用法属下：</p>
<pre><code>assert_response(resp, contains=None, matches=None, headers=None, status=&quot;200&quot;)
</code></pre><p>把你调用<code>app.request</code>得到的响应传递给这个函数，然后将你要检查的内容作为参数传递给诶这个函数。你可以使用<code>contains</code>参数来检查响应中是否包含指定的值，使用<code>status</code>参数可以检查指定的响应状态。这个小函数其实包含了很多的信息，所以你还是自己研究一下的比较好。</p>
<p>在 <code>tests/app_tests.py</code> 自动测试脚本中，我首先确认 <code>/</code> 返回了一个“404 Not Found”响应，因为这个 URL 其实是不存在的。然后我检查了 <code>/hello</code> 在 <code>GET</code>和<code>POST</code>两种请求的情况下都能正常工作。就算你没有弄明白测试的原理，这些测试代码应该是很好读懂的。</p>
<p>花一些时间研究一下这个最新版的 web 程序，重点研究一下自动测试的工作原理。确认你理解了将<code>bin/app.py</code> 做为一个模块导入，然后进行自动化测试的流程。这是一个很重要的技巧，它会引导你学到更多东西。</p>
<h2 id="附加题"><a href="#附加题" class="headerlink" title="附加题"></a>附加题</h2><blockquote>
<ol>
<li>阅读和 HTML 相关的更多资料，然后为你的表单设计一个更好的输出格式。你可以先在纸上设计出来，然后用 HTML 去实现它。</li>
<li>这是一道难题，试着研究一下如何进行文件上传，通过网页上传一张图像，然后将其保存到磁盘中。</li>
<li>更难的难题，找到 <code>HTTP RFC</code> 文件（讲述 HTTP 工作原理的技术文件），然后努力阅读一下。这是一篇很无趣的文档，不过偶尔你会用到里边的一些知识。</li>
<li>又是一道难题，找人帮你设置一个 web 服务器，例如 <code>Apache</code>、<code>Nginx</code>、或者 <code>thttpd</code>。试着让服务器服务一下你创建的 .html 和 .css 文件。如果失败了也没关系，web 服务器本来就都有点挫。</li>
<li>完成上面的任务后休息一下，然后试着多创建一些 web 程序出来。你应该仔细阅读<code>web.py</code>(它和<code>lpthw.web</code>是同一个程序)中关于会话(session)的内容，这样你可以 明白如何保持用户的状态信息。</li>
</ol>
</blockquote>
<h2 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h2><h3 id="Q-我遇到报错信息ImportError-quot-No-module-named-bin-app-quot"><a href="#Q-我遇到报错信息ImportError-quot-No-module-named-bin-app-quot" class="headerlink" title="Q: 我遇到报错信息ImportError &quot;No module named bin.app&quot;"></a>Q: 我遇到报错信息<code>ImportError &quot;No module named bin.app&quot;</code></h3><blockquote>
<p>这个问题要么是你在错误的目录下启动了服务，要么是没有<code>bin/__init__.py</code>这个文件，再或者是你没有在你的shell中设置<code>PYTHONPATH=.</code>。请永远记住这些解决方案，因为这些错误是如此令人难以置信的普遍发生，当他们发生的时候，还会拖慢你服务的速度。</p>
</blockquote>
<h3 id="Q-当我运行模板的时候，我遇到报错-template-takes-no-arguments-1-given"><a href="#Q-当我运行模板的时候，我遇到报错-template-takes-no-arguments-1-given" class="headerlink" title="Q: 当我运行模板的时候，我遇到报错__template__() takes no arguments (1 given)"></a>Q: 当我运行模板的时候，我遇到报错<code>__template__() takes no arguments (1 given)</code></h3><blockquote>
<p>你可能忘记把这个变量 <code>$def with (greeting)</code>或者类似的变量放在模板的顶部了。</p>
</blockquote>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/python/">python</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Python/">Python</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-learn-python-the-hard-way-exercise50" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2014/12/02/learn-python-the-hard-way-exercise50/" class="article-date">
  	<time datetime="2014-12-02T13:20:17.000Z" itemprop="datePublished">2014-12-02</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/12/02/learn-python-the-hard-way-exercise50/">笨办法学Python--exercise50.你的第一个网站</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>最后的3个练习将会很难，你需要在他们身上多花一些时间。第一个练习里你将创建一个简单的web版本的游戏。在你开始这节练习以前，你必须已经成功地完成过了《习题 46》的内容，正确安装了pip，而且学会了如何安装软件包以及如何创建项目骨架。如果你不记得这些内容，就回到《习题 46》重新复习一遍。</p>
<h2 id="安装-lpthw-web"><a href="#安装-lpthw-web" class="headerlink" title="安装 lpthw.web"></a>安装 lpthw.web</h2><p>在创建你的第一个网页应用程序之前，你需要安装一个“Web 框架”，它的名字叫<code>lpthw.web</code>。所谓的“框架”通常是指“让某件事情做起来更容易的软件包”。在网页应用的世界里，人们创建了各种各样的“网页框架”，用来解决他们在创建网站时碰到的问题，然后把这些解决方案用软件包的方式发布出来，这样你就可以利用它们引导创建你自己的项目了。</p>
<p>可选的框架类型有很多很多，不过在这里我们将使用<code>lpthw.web</code> 框架。你可以先学会它，等到差不多的时候再去接触其它的框架，不过 <code>lpthw.web</code> 本身挺不错的，所以就算你一直使用也没关系。</p>
<p>使用<code>pip</code>安装<code>lpthw.web</code>：</p>
<pre><code>$ sudo pip install lpthw.web
[sudo] password for zedshaw:
Downloading/unpacking lpthw.web
  Running setup.py egg_info for package lpthw.web

Installing collected packages: lpthw.web
  Running setup.py install for lpthw.web

Successfully installed lpthw.web
Cleaning up...
</code></pre><p>以上是 Linux 和 Mac OSX 系统下的安装命令，如果你使用的是 Windows，那你只要把<code>sudo</code>去掉就可以了。如果你无法正常安装，请回到《习题 46》，确认自己学会了里边的内容。</p>
<blockquote>
<p><strong>Warning:</strong><br>其他 Python 程序员会警告你说<code>lpthw.web</code>只是另外一个叫做<code>web.py</code>的 Web 框架的代码分支(fork)，而<code>web.py</code>又包含了太多的“魔法(magic)”在里边。如果他们这么说的话，你告诉他们<code>Google App Engine</code>最早用的就是 <code>web.py</code>，但没有一个 Python 程序员抱怨过它里边包含了太多的魔法，因为 Google 用它也没啥问题。如果Google觉得它可以，那它对你来说也不会差。所以还是回去继续学习吧，他们这些说法与其说是教导你，不如说是拿他们自己的教条束缚你，你还是忽略这些说法好了。</p>
</blockquote>
<h2 id="写一个简单的“Hello-World”项目"><a href="#写一个简单的“Hello-World”项目" class="headerlink" title="写一个简单的“Hello World”项目"></a>写一个简单的“Hello World”项目</h2><p>现在我们使用<code>lpthw.web</code>做一个非常简单的“Hello World”项目出来，首先你要创建一个项目目录：</p>
<pre><code>$ cd projects
$ mkdir gothonweb
$ cd gothonweb
$ mkdir bin gothonweb tests docs templates
$ touch gothonweb/__init__.py
$ touch tests/__init__.py
</code></pre><p>你最终的目的是把《习题43》中的游戏做成一个web应用，所以你的项目名称叫做<code>gothonweb</code>，不过在此之前，你需要创建一个最基本的 <code>lpthw.web</code> 应用，将下面的代码放到 <code>bin/app.py</code> 中：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> web</span><br><span class="line"></span><br><span class="line">urls = (</span><br><span class="line">  <span class="string">'/'</span>, <span class="string">'index'</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">app = web.application(urls, globals())</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">index</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">GET</span><span class="params">(self)</span>:</span></span><br><span class="line">        greeting = <span class="string">"Hello World"</span></span><br><span class="line">        <span class="keyword">return</span> greeting</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure></p>
<p>然后使用下面的方法来运行这个 web 程序：</p>
<pre><code>$ python bin/app.py
http://0.0.0.0:8080/
</code></pre><p>如果你这样做：</p>
<pre><code>$ cd bin/   # WRONG! WRONG! WRONG!
$ python app.py  # WRONG! WRONG! WRONG!
</code></pre><p>那么你就错了。在所有Python项目中，都不会用<code>cd</code>到下一级目录中去启动服务，你就在最顶层的目录启动服务，这样所有的系统可以访问所有的模块和文件。 去重读习题46并理解项目布局和如何使用它。</p>
<p>最后，使用你的网页浏览器，打开 URL <code>http://localhost:8080/</code>，你应该看到两样东西，首先是浏览器里显示了 <code>Hello, world!</code>，然后是你的命令行终端显示了如下的输出：</p>
<pre><code>$ python bin/app.py
http://0.0.0.0:8080/
127.0.0.1:59542 - - [13/Jun/2011 11:44:43] &quot;HTTP/1.1 GET /&quot; - 200 OK
127.0.0.1:59542 - - [13/Jun/2011 11:44:43] &quot;HTTP/1.1 GET /favicon.ico&quot; - 404 Not Found
</code></pre><p>这些是<code>lpthw.web</code> 打印出的 log 信息，从这些信息你可以看出服务器有在运行，而且能了解到程序在浏览器背后做了些什么事情。这些信息还有助于你发现程序的问题。例如在最后一行它告诉你浏览器试图获取<code>/favicon.ico</code>，但是这个文件并不存在，因此它返回的状态码是 <code>404 Not Found</code>。</p>
<p>到这里，我还没有讲到任何 web 相关的工作原理，因为首先你需要完成准备工作，以便后面的学习能顺利进行，接下来的两节习题中会有详细的解释。我会要求你用各种方法把你的 lpthw.web 应用程序弄坏，然后再将其重新构建起来：这样做的目的是让你明白运行lpthw.web 程序需要准备好哪些东西.</p>
<h2 id="发生了什么？"><a href="#发生了什么？" class="headerlink" title="发生了什么？"></a>发生了什么？</h2><p>在浏览器访问到你的网页应用程序时，发生了下面一些事情：</p>
<blockquote>
<ol>
<li>浏览器通过网络连接到你自己的电脑，它的名字叫做<code>localhost</code>，这是一个标准称谓，表示的谁就是网络中你自己的这台计算机，不管它实际名字是什么，你都可以使用localhost 来访问。它使用到的网络端口是8080。</li>
<li>连接成功以后，浏览器对<code>bin/app.py</code>这个应用程序发出了 HTTP 请求(request)，要求访问 URL <code>/</code>，这通常是一个网站的第一个 URL。</li>
<li>在<code>bin/app.py</code> 里，我们有一个列表，里边包含了 URL 和类的匹配关系。我们这里只定义了一组匹配，那就是 <code>&#39;/&#39;, &#39;index&#39;</code> 的匹配。它的含义是：如果有人使用浏览器访问 / 这一级目录，<code>lpthw.web</code> 将找到并加载 <code>class index</code>，从而用它处理这个浏览器请求。</li>
<li>现在 <code>lpthw.web</code> 找到了<code>class index</code>，然后针对这个类的一个实例调用了 <code>index.GET</code> 这个方法函数。该函数运行后返回了一个字符串，以供<code>lpthw.web</code> 将其传递给浏览器。</li>
<li>最后<code>lpthw.web</code> 完成了对于浏览器请求的处理，将响应(response)回传给浏览器，于是你就看到了现在的页面。</li>
</ol>
</blockquote>
<p>确定你真的弄懂了这些，你需要画一个流程图，来理清信息是如何从浏览器传递到<code>lpthw.web</code>，再到<code>index.GET</code>，再回到你的浏览器的。</p>
<h2 id="修正错误"><a href="#修正错误" class="headerlink" title="修正错误"></a>修正错误</h2><p>第一步，把第 11 行的<code>greeting</code>变量赋值删掉，然后刷新浏览器。你应该会看到一个错误页面，你可以通过这一页丰富的错误信息看出你的程序崩溃的原因是什么。当然你已经知道出错的原因是<code>greeting</code>的赋值丢失了，不过 <code>lpthw.web</code>还是会给你一个挺好的错误页面，让你能找到出错的具体位置。试试在这个错误页面上做以下操作：</p>
<blockquote>
<ol>
<li>检查每一段<code>Local vars</code>输出（用鼠标点击它们），追踪里边提到的变量名称，以及它们是在哪些代码文件中用到的。</li>
<li>阅读<code>Request Information</code> 一节，看看里边哪些知识是你已经熟悉了的。Request 是浏览器发给你的 <code>gothonweb</code>应用程序的信息。这些知识对于日常网页浏览没有什么用处，但现在你要学会这些东西，以便写出 web 应用程序来。<br>3.试着把这个小程序的别的位置改错，探索一下会发生什么事情。<code>lpthw.web</code> 的会把一些错误信息和堆栈跟踪(stack trace)信息显示在命令行终端，所以别忘了检查命令行终端的信息输出。</li>
</ol>
</blockquote>
<h2 id="创建基本的模板文件"><a href="#创建基本的模板文件" class="headerlink" title="创建基本的模板文件"></a>创建基本的模板文件</h2><p>你已经试过用各种方法把这个 lpthw.web 程序改错，不过你有没有注意到“Hello World”不是一个好 HTML 网页呢？这是一个 web 应用，所以需要一个合适的 HTML 响应页面才对。为了达到这个目的，下一步你要做的是将“Hello World”以较大的绿色字体显示出来。</p>
<p>第一步是创建一个<code>templates/index.html</code>文件，内容如下：</p>
<pre><code>$def with (greeting)

&lt;html&gt;
    &lt;head&gt;
        &lt;title&gt;Gothons Of Planet Percal #25&lt;/title&gt;
    &lt;/head&gt;
&lt;body&gt;

$if greeting:
    I just wanted to say &lt;em style=&quot;color: green; font-size: 2em;&quot;&gt;$greeting&lt;/em&gt;.
$else:
    &lt;em&gt;Hello&lt;/em&gt;, world!

&lt;/body&gt;
&lt;/html&gt;
</code></pre><p>如果你学过 HTML 的话，这些内容你看上去应该很熟悉。如果你没学过 HTML，那你应该去研究一下，试着用 HTML 写几个网页，从而知道它的工作原理。不过我们这里的 HTML 文件其实是一个“模板(template)”，如果你向模板提供一些参数，<code>lpthw.web</code> 就会在模板中找到对应的位置，将参数的内容填充到模板中。例如每一个出现 <code>$greeting</code>的位置，<code>$greeting</code>的内容都会被替换成对应这个变量名的参数。</p>
<p>为了让你的<code>bin/app.py</code>处理模板，你需要写一写代码，告诉<code>lpthw.web</code> 到哪里去找到模板进行加载，以及如何渲染(render)这个模板，按下面的方式修改你的 app.py：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> web</span><br><span class="line"></span><br><span class="line">urls = (</span><br><span class="line">  <span class="string">'/'</span>, <span class="string">'Index'</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">app = web.application(urls, globals())</span><br><span class="line"></span><br><span class="line">render = web.template.render(<span class="string">'templates/'</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Index</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">GET</span><span class="params">(self)</span>:</span></span><br><span class="line">        greeting = <span class="string">"Hello World"</span></span><br><span class="line">        <span class="keyword">return</span> render.index(greeting = greeting)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure>
<p>特别注意一下<code>render</code>这个新变量名，注意我修改了<code>index.GET</code> 的最后一行，让它返回了<code>render.index()</code>，并且将<code>greeting</code> 变量作为参数传递给了这个函数。</p>
<p>改好上面的代码后，刷新一下浏览器中的网页，你应该会看到一条和之前不同的绿色信息输出。你还可以在浏览器中通过“查看源文件(View Source)”看到模板被渲染成了标准有效的 HTML 源代码。</p>
<p>这么讲也许有些太快了，我来详细解释一下模板的工作原理吧：</p>
<blockquote>
<ol>
<li>在<code>bin/app.py</code>里面你添加了一个叫做<code>render</code>的新变量，它本身是一个 <code>web.template.render</code>对象。</li>
<li>你将<code>templates/</code> 作为参数传递给了这个对象，这样就让<code>render</code> 知道了从哪里去加载模板文件。</li>
<li>在你后面的代码中，当浏览器一如既往地触发了<code>index.GET</code> 以后，它没有再返回简单的<code>greeting</code>字符串，取而代之的是你调用了 <code>render.index</code>，而且将问候语句作为一个变量传递给它。</li>
<li>这个<code>render_template</code>函数可以说是一个“魔法函数”，它看到了你需要的是<code>index.html</code>，于是就跑到<code>templates/</code>目录下，找到名字为<code>index.html</code> 的文件，然后就把它渲染(render)一遍（叫“转换一遍”也可以）。</li>
<li>在<code>templates/index.html</code>文件中，你可以看到初始定义一行中说这个模板需要使用一个叫<code>greeting</code>的参数，这和函数定义中的格式差不多。另外和 Python 语法一样，模板文件是缩进敏感的，所以要确认自己弄对了缩进。</li>
<li>最后，你让<code>templates/index.html</code>去检查<code>greeting</code>这个变量，如果这个变量存在的话，就打印出变量的内容，如果不存在的话，就会打印出一个默认的问候信息。</li>
</ol>
</blockquote>
<p>要深入理解这个过程，你可以修改 greeting 变量以及 HTML 模板的内容，看看会有什么效果。然后创建一个叫做<code>templates/foo.html</code>  的模板，并且使用一个新的<code>render.foo()</code>去渲染它。从这个过程你也可以看出， <code>render</code> 调用的函数名称只要跟 <code>templates/</code>下的 <code>.html</code> 文件名匹配到，这个 HTML 模板就可以被渲染到了。</p>
<h2 id="附加题"><a href="#附加题" class="headerlink" title="附加题"></a>附加题</h2><blockquote>
<ol>
<li>阅读<code>http://webpy.org/</code> 里边的文档，它其实和<code>lpthw.web</code> 是同一个项目。</li>
<li>实验一下你在上述网站看到的所有的东西，包括里边的代码示例。</li>
<li>阅读以下 HTML5 和 CSS3 相关的东西，自己练习着写几个 <code>.html</code> 和 <code>.css 文件</code>。</li>
<li>如果你有一个懂 Django 朋友可以帮你的话，你可以试着使用 Django 完成一下习题 50、51、52，看看结果会是什么样子的。</li>
</ol>
</blockquote>
<h2 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h2><h3 id="Q-我好想无法连接到http-localhost-8080"><a href="#Q-我好想无法连接到http-localhost-8080" class="headerlink" title="Q: 我好想无法连接到http://localhost:8080/"></a>Q: 我好想无法连接到<code>http://localhost:8080/</code></h3><blockquote>
<p>那么试试访问<code>http://127.0.0.1:8080/</code></p>
</blockquote>
<h3 id="Q-lpthw-web-和-web-py有什么区别？"><a href="#Q-lpthw-web-和-web-py有什么区别？" class="headerlink" title="Q: lpthw.web 和 web.py有什么区别？"></a>Q: <code>lpthw.web</code> 和 <code>web.py</code>有什么区别？</h3><blockquote>
<p>没有区别。我只是在特定版本“锁定”<code>web.py</code>，以使它对所有学生都是一样的，然后再命名为<code>lpthw.web</code>，上一个版本的<code>web.py</code>可能就不同于这一版本。</p>
</blockquote>
<h3 id="Q-我的代码找不到index-html-或者其他文件"><a href="#Q-我的代码找不到index-html-或者其他文件" class="headerlink" title="Q: 我的代码找不到index.html(或者其他文件)"></a>Q: 我的代码找不到<code>index.html</code>(或者其他文件)</h3><blockquote>
<p>你可能是先执行了<code>cd bin/</code>，不要执行这一句，所有的命令都应该在<code>bin/</code>的上一级目录执行，所以如果你不能执行<code>python bin/app.py</code>,说明你在错误的目录上。</p>
</blockquote>
<h3 id="Q-当我们调用模板的时候，为什么要执行greeting-greeting赋值操作"><a href="#Q-当我们调用模板的时候，为什么要执行greeting-greeting赋值操作" class="headerlink" title="Q: 当我们调用模板的时候，为什么要执行greeting=greeting赋值操作"></a>Q: 当我们调用模板的时候，为什么要执行<code>greeting=greeting</code>赋值操作</h3><blockquote>
<p>你并没有给<code>greeting</code>赋值，你只是给模板设定一个命名参数。这是声明的一种，但它只影响调用模板的功能。 </p>
</blockquote>
<h3 id="Q-我的电脑上不能使用8080端口"><a href="#Q-我的电脑上不能使用8080端口" class="headerlink" title="Q: 我的电脑上不能使用8080端口"></a>Q: 我的电脑上不能使用8080端口</h3><blockquote>
<p>你可能有一个杀毒程序占用了这个端口，试试别的端口。</p>
</blockquote>
<h3 id="Q-安装lpthw-web-时，我遇到报错信息ImportError-quot-No-module-named-web-quot"><a href="#Q-安装lpthw-web-时，我遇到报错信息ImportError-quot-No-module-named-web-quot" class="headerlink" title="Q: 安装lpthw.web 时，我遇到报错信息ImportError &quot;No module named web&quot;"></a>Q: 安装<code>lpthw.web</code> 时，我遇到报错信息<code>ImportError &quot;No module named web&quot;</code></h3><blockquote>
<p>你可能安装了多个版本的Python并且正在使用一个错误的版本，或者你是因为使用了一个旧版本的<code>pip</code>，导致安装没有成功，试着先卸载<code>lpthw.web</code>，在重装一次，如果还没有解决问题，再次确认下你是否使用了正确的Python版本。</p>
</blockquote>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/python/">python</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Python/">Python</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-learn-python-the-hard-way-exercise49" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2014/12/02/learn-python-the-hard-way-exercise49/" class="article-date">
  	<time datetime="2014-12-02T08:20:41.000Z" itemprop="datePublished">2014-12-02</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/12/02/learn-python-the-hard-way-exercise49/">笨办法学Python--exercise49.写代码语句</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>从这个小游戏的词汇扫描器中，我们应该可以得到类似下面的列表：</p>
<pre><code>python 2.7.1 (r271:86832, Jun 16 2011, 16:59:05) 
[GCC 4.2.1 (Based on Apple Inc. build 5658) (LLVM build 2335.15.00)] on darwin
Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.
&gt;&gt;&gt; from ex48 import lexicon
&gt;&gt;&gt; lexicon.scan(&quot;go north&quot;)
[(&apos;verb&apos;, &apos;go&apos;), (&apos;direction&apos;, &apos;north&apos;)]
&gt;&gt;&gt; lexicon.scan(&quot;kill the princess&quot;)
[(&apos;verb&apos;, &apos;kill&apos;), (&apos;stop&apos;, &apos;the&apos;), (&apos;noun&apos;, &apos;princess&apos;)]
&gt;&gt;&gt; lexicon.scan(&quot;eat the bear&quot;)
[(&apos;verb&apos;, &apos;eat&apos;), (&apos;stop&apos;, &apos;the&apos;), (&apos;noun&apos;, &apos;bear&apos;)]
&gt;&gt;&gt; lexicon.scan(&quot;open the door and smack the bear in the nose&quot;)
[(&apos;error&apos;, &apos;open&apos;), (&apos;stop&apos;, &apos;the&apos;), (&apos;error&apos;, &apos;door&apos;), (&apos;error&apos;, &apos;and&apos;), (&apos;error&apos;, &apos;smack&apos;), (&apos;stop&apos;, &apos;the&apos;), (&apos;noun&apos;, &apos;bear&apos;), (&apos;stop&apos;, &apos;in&apos;), (&apos;stop&apos;, &apos;the&apos;), (&apos;error&apos;, &apos;nose&apos;)]
</code></pre><p>现在让我们把它转化成游戏可以使用的东西，也就是一个<code>Sentence</code>类。</p>
<p>如果你还记得学校学过的东西的话，一个句子是由这样的结构组成的：<br>主语(Subject) + 谓语(动词 Verb) + 宾语(Object)</p>
<p>很显然实际的句子可能会比这复杂，而你可能已经在英语的语法课上面被折腾得够呛了。我们的目的，是将上面的元组列表转换为一个<code>Sentence</code> 对象，而这个对象又包含主谓宾各个成员。</p>
<h2 id="匹配-Match-和窥视-Peek"><a href="#匹配-Match-和窥视-Peek" class="headerlink" title="匹配(Match)和窥视(Peek)"></a>匹配(Match)和窥视(Peek)</h2><p>为了达到这个效果，你需要四(五)样工具：</p>
<blockquote>
<ol>
<li>循环访问元组列表的方法，这挺简单的。</li>
<li>匹配我们的主谓宾设置中不同种类元组的方法。</li>
<li>一个“窥视”潜在元组的方法，以便做决定时用到。</li>
<li>跳过(skip)我们不在乎的内容的方法，例如形容词、冠词等没有用处的词汇。</li>
<li>一个用来存放最终结果的<code>Sentence</code>对象</li>
</ol>
</blockquote>
<p>我们要把这些函数放在一个叫做<code>ex48.parser</code>的类中，再把这个类放在<code>ex48/parser.py</code>中，以便于我们能够测试它们。我们使用<code>peek</code>函数来查看元组列表中的下一个成员，做匹配以后再对它做下一步动作。</p>
<h2 id="句子的语法"><a href="#句子的语法" class="headerlink" title="句子的语法"></a>句子的语法</h2><p>在你写代码之前，你要弄明白一个基础的英语句子的语法是如何工作的。在我们的练习中，我们准备创建一个叫做<code>Sentence</code>的类，它有如下3个属性：</p>
<p>Sentence.subject（句子的主语）<br>这是任意一个句子的主语，大部分时候可以默认为“玩家player”，比如一个句子“run north 向北跑”, 也就是说 “player run north 玩家向北跑”。主语应该是一个名词。</p>
<p>Sentence.verb（句子的谓语）<br>这就是句子的的作用。 在 “run north” 中，谓语应该是 “run”. 谓语应该是一个动词。</p>
<p>Sentence.object（句子的宾语）<br>    这又是一个名词，指的是动词做了什么。在我们游戏中， 我们分辨出的方向就是宾语。在 “run north” 中，单词”north”就是宾语。在 “hit bear” 中，单词”bear” 就是宾语。</p>
<p>我们的程序解析器使用我们给出的函数并返回解析后的句子，转换成一个<code>list</code>或<code>Sentence</code>对象，用来接收匹配用户输入</p>
<h2 id="关于异常-Exception"><a href="#关于异常-Exception" class="headerlink" title="关于异常(Exception)"></a>关于异常(Exception)</h2><p>已经简单学过关于异常的一些东西，但还没学过怎样抛出(raise)它们。这节的代码演示了如何 raise 前面定义的<code>ParserError</code>。注意<code>ParserError</code> 是一个定义为<code>Exception</code> 类型的 class。另外要注意我们是怎样使用<code>raise</code> 这个关键字来抛出异常的。</p>
<p>你的测试代码应该也要测试到这些异常，这个我也会演示给你如何实现。</p>
<h2 id="程序代码"><a href="#程序代码" class="headerlink" title="程序代码"></a>程序代码</h2><p>如果你希望更大的挑战，停在这里，然后只听我的描述来完成代码。当你遇到难题的时候，可以再回来看看是我如何做的。不过，尝试自己实现代码功能对你来说真的是个很好的锻炼。我要开始串讲我的代码了，你可以开始在自己的<code>ex48/parser.py</code>中输入代码。我们从异常处理开始我们的代码编写：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ParserError</span><span class="params">(Exception)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure></p>
<p>这就是你创建一个可以抛出的异常类<code>ParserError</code>,接下来，我们需要一个句子类 <code>Sentence</code>：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Sentence</span><span class="params">(object)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, subject, verb, obj)</span>:</span></span><br><span class="line">        <span class="comment"># remember we take ('noun','princess') tuples and convert them</span></span><br><span class="line">        self.subject = subject[<span class="number">1</span>]</span><br><span class="line">        self.verb = verb[<span class="number">1</span>]</span><br><span class="line">        self.object = obj[<span class="number">1</span>]</span><br></pre></td></tr></table></figure></p>
<p>到目前为止，我们没有写什么特别的代码，只是创建了两个简单的类。</p>
<p>在我们的问题描述中，我们需要一个函数用来看到列表中的单词并返回单词的类型：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">peek</span><span class="params">(word_list)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> word_list:</span><br><span class="line">        word = word_list[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">return</span> word[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">None</span></span><br></pre></td></tr></table></figure></p>
<p>我们需要这个函数是因为，我们要基于下一个单词来选择确认我们要处理的句子是什么，然后我们可以调用另一个函数来处理这个单词，并将程序继续下去。</p>
<p>我们使用<code>match</code>函数来处理单词，用它来确认预期中的单词是否是正确的类型，将它移出列表，并返回该词：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">match</span><span class="params">(word_list, expecting)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> word_list:</span><br><span class="line">        word = word_list.pop(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> word[<span class="number">0</span>] == expecting:</span><br><span class="line">            <span class="keyword">return</span> word</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">None</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">None</span></span><br></pre></td></tr></table></figure></p>
<p>相当简单是不是，不过还是要确认你理解了这些代码以及为什么我是这么写的。我需要依据我看到的列表中的下一个单词来决定我现在处理的句子的类型，然后再用这个单词创建我的<code>Sentence</code>.</p>
<p>最后，我们需要一个方法来跳过句子中我们不关心的单词。这些单词会被打上“停用词”（stop类型的词）的标签，比如”the”,”and”以及”a”等：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">skip</span><span class="params">(word_list, word_type)</span>:</span></span><br><span class="line">    <span class="keyword">while</span> peek(word_list) == word_type:</span><br><span class="line">        match(word_list, word_type)</span><br></pre></td></tr></table></figure></p>
<p>记住<code>skip</code>不只跳过一个单词而是跳过所有该类型的词，也就是说，如果有人输入了“scream at the bear”，经过处理最后会得到”scream” 和 “bear”.</p>
<p>以上是我们分析函数的基本结构，我可以用它们来处理我们需要的任何文本，尽管我们的程序非常简单，剩下的函数也都是非常短的。</p>
<p>首先，我们来完成解析动词的部分：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse_verb</span><span class="params">(word_list)</span>:</span></span><br><span class="line">    skip(word_list, <span class="string">'stop'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> peek(word_list) == <span class="string">'verb'</span>:</span><br><span class="line">        <span class="keyword">return</span> match(word_list, <span class="string">'verb'</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> ParserError(<span class="string">"Expected a verb next."</span>)</span><br></pre></td></tr></table></figure></p>
<p>我们跳过所有”stop”类型的词，然后提前获得下一个单词，并确认它是”verb”类型，如果不是，则抛出一个异常<code>ParserError</code>说明为什么不是。如果是”verb”类型，则使用”match”处理，将它移出列表。一个处理”sentence”类的类似函数：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse_object</span><span class="params">(word_list)</span>:</span></span><br><span class="line">    skip(word_list, <span class="string">'stop'</span>)</span><br><span class="line">    next_word = peek(word_list)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> next_word == <span class="string">'noun'</span>:</span><br><span class="line">        <span class="keyword">return</span> match(word_list, <span class="string">'noun'</span>)</span><br><span class="line">    <span class="keyword">elif</span> next_word == <span class="string">'direction'</span>:</span><br><span class="line">        <span class="keyword">return</span> match(word_list, <span class="string">'direction'</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> ParserError(<span class="string">"Expected a noun or direction next."</span>)</span><br></pre></td></tr></table></figure></p>
<p>重复操作，跳过”stop”类型的词，提前判断下一个词，决定下一个”sentence”.在函数<code>parse_object</code>中，我们需要同时处理“名词”和类似宾语的“方向”，解析主语的方法也是一样的，但是当我们处理隐藏的名词”player”的时候，我们需要用到”peek”：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse_subject</span><span class="params">(word_list)</span>:</span></span><br><span class="line">    skip(word_list, <span class="string">'stop'</span>)</span><br><span class="line">    next_word = peek(word_list)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> next_word == <span class="string">'noun'</span>:</span><br><span class="line">        <span class="keyword">return</span> match(word_list, <span class="string">'noun'</span>)</span><br><span class="line">    <span class="keyword">elif</span> next_word == <span class="string">'verb'</span>:</span><br><span class="line">        <span class="keyword">return</span> (<span class="string">'noun'</span>, <span class="string">'player'</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> ParserError(<span class="string">"Expected a verb next."</span>)</span><br></pre></td></tr></table></figure></p>
<p>所有的方式都准备好之后，我们最后一个函数<code>parse_sentence</code>也是非常简单的：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse_sentence</span><span class="params">(word_list)</span>:</span></span><br><span class="line">    subj = parse_subject(word_list)</span><br><span class="line">    verb = parse_verb(word_list)</span><br><span class="line">    obj = parse_object(word_list)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Sentence(subj, verb, obj)</span><br></pre></td></tr></table></figure></p>
<h2 id="试玩这个游戏"><a href="#试玩这个游戏" class="headerlink" title="试玩这个游戏"></a>试玩这个游戏</h2><p>为了弄明白程序是如何运行，你可以像这样试玩：</p>
<pre><code>Python 2.7.1 (r271:86832, Jun 16 2011, 16:59:05) 
[GCC 4.2.1 (Based on Apple Inc. build 5658) (LLVM build 2335.15.00)] on darwin
Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.
&gt;&gt;&gt; from ex48.parser import *
&gt;&gt;&gt; x = parse_sentence([(&apos;verb&apos;, &apos;run&apos;), (&apos;direction&apos;, &apos;north&apos;)])
&gt;&gt;&gt; x.subject
&apos;player&apos;
&gt;&gt;&gt; x.verb
&apos;run&apos;
&gt;&gt;&gt; x.object
&apos;north&apos;
&gt;&gt;&gt; x = parse_sentence([(&apos;noun&apos;, &apos;bear&apos;), (&apos;verb&apos;, &apos;eat&apos;), (&apos;stop&apos;, &apos;the&apos;), (&apos;noun&apos;, &apos;honey&apos;)])
&gt;&gt;&gt; x.subject
&apos;bear&apos;
&gt;&gt;&gt; x.verb
&apos;eat&apos;
&gt;&gt;&gt; x.object
&apos;honey&apos;
</code></pre><h2 id="你应该测试的东西"><a href="#你应该测试的东西" class="headerlink" title="你应该测试的东西"></a>你应该测试的东西</h2><p>为《习题 49》写一个完整的测试方案，确认代码中所有的东西都能正常工作，把测试代码放到文件<code>tests/parser_tests.py</code>中，测试代码中也要包含对异常的测试——输入一个错误的句子它会抛出一个异常来。</p>
<p>使用<code>assert_raises</code>这个函数来检查异常，在 <code>nose</code> 的文档里查看相关的内容，学着使用它写针对“执行失败”的测试，这也是测试很重要的一个方面。从<code>nose</code>文档中学会<code>assert_raises</code>以及一些别的函数的使用方法。</p>
<p>写完测试以后，你应该就明白了这段程序的工作原理，而且也学会了如何为别人的程序写测试代码。 相信我，这是一个非常有用的技能。</p>
<h2 id="附加题"><a href="#附加题" class="headerlink" title="附加题"></a>附加题</h2><blockquote>
<ol>
<li>修改 <code>parse_</code>函数（方法），将它们放到一个类里边，而不仅仅是独立的方法函数。这两种程序设计你喜欢哪一种呢？</li>
<li>提高 <code>parser</code>的容错能力，这样即使用户输入了你预定义语汇之外的词语，你的程序也能正常运行下去。</li>
<li>改进语法，让它可以处理更多的东西，例如数字。</li>
<li>想想在游戏里你的<code>Sentence</code>类可以对用户输入做哪些有趣的事情。</li>
</ol>
</blockquote>
<h2 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h2><h3 id="Q-我好像不能让assert-raises正常运行"><a href="#Q-我好像不能让assert-raises正常运行" class="headerlink" title="Q: 我好像不能让assert_raises正常运行"></a>Q: 我好像不能让<code>assert_raises</code>正常运行</h3><blockquote>
<p>确认你写的是<code>assert_raises(exception, callable, parameters)</code>而不是<code>assert_raises(exception, callable(parameters))</code>。注意一下第二种写法中，调用了函数<code>callable</code>并将返回值传递给<code>assert_raises</code>，这种写法是错误的，你应该把要调用的函数也作为参数传递给<code>assert_raises</code>。</p>
</blockquote>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/python/">python</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Python/">Python</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-learn-python-the-hard-way-exercise48" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2014/12/01/learn-python-the-hard-way-exercise48/" class="article-date">
  	<time datetime="2014-12-01T12:41:07.000Z" itemprop="datePublished">2014-12-01</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/12/01/learn-python-the-hard-way-exercise48/">笨办法学Python--exercise48.更复杂的用户输入</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>在以前的游戏中，你只是设置一些简单的预定义字符串作为用户输入处理，用户输入“run”，程序能正常运行，但是你输入“run fast”，程序就会运行失败。我们需要一个设备，它可以识别用户以各种方式输入的语汇。例如下面的机种表述都应该被支持才对：</p>
<blockquote>
<ul>
<li>open door</li>
<li>open the door</li>
<li>go THROUGH the door</li>
<li>punch bear</li>
<li>Punch The Bear in the FACE</li>
</ul>
</blockquote>
<p>也就是说，如果用户的输入和常用英语很接近也应该是可以的，而你的游戏要识别出它们的意思。为了达到这个目的，我们将写一个模块专门做这件事情。这个模组里边会有若干个类，它们互相配合，接受用户输入，并且将用户输入转换成你的游戏可以识别的命令。</p>
<p>英语的简单格式是这个样子的：</p>
<blockquote>
<ul>
<li>单词由空格隔开。</li>
<li>句子由单词组成。</li>
<li>语法控制句子的含义。</li>
</ul>
</blockquote>
<p>以最好的开始方式是先搞定如何得到用户输入的词汇，并判断出它们是什么。</p>
<h2 id="我们的游戏词典"><a href="#我们的游戏词典" class="headerlink" title="我们的游戏词典"></a>我们的游戏词典</h2><p>我在游戏里创建了下面这些语汇：</p>
<blockquote>
<ul>
<li>表示方向: north, south, east, west, down, up, left, right, back.</li>
<li>动词: go, stop, kill, eat.</li>
<li>修饰词: the, in, of, from, at, it</li>
<li>名词: door, bear, princess, cabinet.</li>
<li>数字: 由 0-9 构成的数字。</li>
</ul>
</blockquote>
<p>说到名词，我们会碰到一个小问题，那就是不一样的房间会用到不一样的一组名词，不过让我们先挑一小组出来写程序，以后再做改进。</p>
<h3 id="如何断句"><a href="#如何断句" class="headerlink" title="如何断句"></a>如何断句</h3><p>我们已经有了词汇表，为了分析句子的意思，接下来我们需要找到一个断句的方法。我们对于句子的定义是“空格隔开的单词”，所以只要这样就可以了：</p>
<pre><code>stuff = raw_input(&apos;&gt; &apos;)
words = stuff.split()
</code></pre><p>目前做到这样就可以了，不过这招在相当一段时间内都不会有问题。</p>
<h3 id="词汇元组"><a href="#词汇元组" class="headerlink" title="词汇元组"></a>词汇元组</h3><p>一旦我们知道了如何将句子转化成词汇列表，剩下的就是逐一检查这些词汇，看它们是什么类型。为了达到这个目的，我们将用到一个非常好使的 Python 数据结构，叫做”元组(tuple)”。元组其实就是一个不能修改的列表。创建它的方法和创建列表差不多，成员之间需要用逗号隔开，不过方括号要换成圆括号 <code>()</code>：</p>
<pre><code>first_word = (&apos;verb&apos;, &apos;go&apos;)
second_word = (&apos;direction&apos;, &apos;north&apos;)
third_word = (&apos;direction&apos;, &apos;west&apos;)
sentence = [first_word, second_word, third_word]
</code></pre><p>这样我们就创建了一个(TYPE,WORD)组，让你识别出单词，并且对它执行指令。</p>
<p>这只是一个例子，不过最后做出来的样子也差不多。你接受用户输入，用 <code>split</code>将其分隔成单词列表，然后分析这些单词，识别它们的类型，最后重新组成一个句子。</p>
<h3 id="扫描输入"><a href="#扫描输入" class="headerlink" title="扫描输入"></a>扫描输入</h3><p>现在你要写的是词汇扫描器。这个扫描器会将用户的输入字符串当做参数，然后返回由多个 (TOKEN, WORD) 组成的一个列表，这个列表实现类似句子的功能。如果一个单词不在预定的词汇表中，那它返回时 WORD 应该还在，但 TOKEN 应该设置成一个专门的错误标记。这个错误标记将告诉用户哪里出错了。</p>
<p>有趣的地方来了。我不会告诉你这些该怎样做，但我会写一个“单元测试(unit test)”，而你要把扫描器写出来，并保证单元测试能够正常通过。</p>
<h3 id="异常和数字"><a href="#异常和数字" class="headerlink" title="异常和数字"></a>异常和数字</h3><p>有一件小事情我会先帮帮你，那就是数字转换。为了做到这一点，我们会作一点弊，使用“异常(exceptions)”来做。“异常”指的是你运行某个函数时得到的错误。你的函数在碰到错误时，就会“抛出(raise)”一个“异常”，然后你就要去处理(handle)这个异常。假如你在Python 里写了这些东西：</p>
<pre><code>Python 2.7.1 (r271:86832, Jun 16 2011, 16:59:05) 
[GCC 4.2.1 (Based on Apple Inc. build 5658) (LLVM build 2335.15.00)] on darwin
Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.
&gt;&gt;&gt; int(&quot;hell&quot;)
Traceback (most recent call last):
  File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;
ValueError: invalid literal for int() with base 10: &apos;hell&apos;
</code></pre><p>这个<code>ValueError</code>就是<code>int()</code>函数抛出的一个异常。因为你给<code>int()</code> 的参数不是一个数字。<code>int()</code>函数其实也可以返回一个值来告诉你它碰到了错误，不过由于它只能返回整数值，所以很难做到这一点。它不能返回 -1，因为这也是一个数字。<code>int()</code>没有纠结在它“究竟应该返回什么”上面，而是提出了一个叫做<code>ValueError</code>的异常，然后你只要处理这个异常就可以了。</p>
<p>处理异常的方法是使用<code>try</code>和<code>except</code>这两个关键字：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">convert_number</span><span class="params">(s)</span>:</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">return</span> int(s)</span><br><span class="line">    <span class="keyword">except</span> ValueError:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">None</span></span><br></pre></td></tr></table></figure></p>
<p>你把要试着运行的代码放到<code>try</code>的区段里，再将出错后要运行的代码放到 <code>except</code>区段里。在这里，我们要试着调用<code>int()</code> 去处理某个可能是数字的东西，如果中间出了错，我们就抓到这个错误，然后返回<code>None</code>。</p>
<p>在你写的扫描器里面，你应该使用这个函数来测试某个东西是不是数字。做完这个检查，你就可以声明这个单词是一个错误单词了。</p>
<h2 id="测试第一的挑战"><a href="#测试第一的挑战" class="headerlink" title="测试第一的挑战"></a>测试第一的挑战</h2><p>测试首先是一种编程策略，你先写一段自动化测试代码，假装代码是在正常运行的，然后你再写出代码保证测试代码能正常运行。这种方法用在当你不知道代码是如何运行，但又可以想象必须使用它的时候。比如说，如果你知道你需要在另一个模块中使用一个新类,但是你不太知道如何实现这个类，那么先写出测试程序。</p>
<p>我将给你一份测试代码，你需要写出代码，保证测试代码能正常工作。为了完成这个任务，你可以看看下面的流程：</p>
<blockquote>
<ol>
<li>创建一小部分我给你的测试代码</li>
<li>确保它运行失败,你知道测试实际上是确认功能的工作原理。 </li>
<li>到你的源代码文件<code>lexicon.py</code>中，写出能使测试代码通过的代码</li>
<li>重复以上工作直到你实现测试中的所有点</li>
</ol>
</blockquote>
<p>当你做到3的时候，和其他编写代码的方法相结合也是很好的方法：</p>
<blockquote>
<ol>
<li>编写你需要的函数或类的基本框架</li>
<li>添加注释，解释说明这个函数是如何运行的</li>
<li>按照描述中的注释写代码</li>
<li>去掉注释</li>
</ol>
</blockquote>
<p>这种写代码的方法被称作“psuedo code”，用在你不知道该如何实现某些功能，但是会用自己的语言来描述这个功能的时候。</p>
<p>结合“test first”和“psuedo code”策略，我们得出一个编程的简易流程：</p>
<blockquote>
<ol>
<li>写一些运行失败的测试用例</li>
<li>写出测试要用的函数、方法、类的基本结构</li>
<li>用自己的语言填充这些框架，解释它们的功能</li>
<li>用代码替换注释，直到测试代码运行通过</li>
<li>重复</li>
</ol>
</blockquote>
<p>在这节练习中，你将通过运行我给你的测试程序逆向运行<code>lexicon.py</code>来实践这个方法。</p>
<p>##　你应该测试的东西<br>这里是你要用到的测试文件：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> nose.tools <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> ex48 <span class="keyword">import</span> lexicon</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_directions</span><span class="params">()</span>:</span></span><br><span class="line">    assert_equal(lexicon.scan(<span class="string">"north"</span>), [(<span class="string">'direction'</span>, <span class="string">'north'</span>)])</span><br><span class="line">    result = lexicon.scan(<span class="string">"north south east"</span>)</span><br><span class="line">    assert_equal(result, [(<span class="string">'direction'</span>, <span class="string">'north'</span>),</span><br><span class="line">                          (<span class="string">'direction'</span>, <span class="string">'south'</span>),</span><br><span class="line">                          (<span class="string">'direction'</span>, <span class="string">'east'</span>)])</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_verbs</span><span class="params">()</span>:</span></span><br><span class="line">    assert_equal(lexicon.scan(<span class="string">"go"</span>), [(<span class="string">'verb'</span>, <span class="string">'go'</span>)])</span><br><span class="line">    result = lexicon.scan(<span class="string">"go kill eat"</span>)</span><br><span class="line">    assert_equal(result, [(<span class="string">'verb'</span>, <span class="string">'go'</span>),</span><br><span class="line">                          (<span class="string">'verb'</span>, <span class="string">'kill'</span>),</span><br><span class="line">                          (<span class="string">'verb'</span>, <span class="string">'eat'</span>)])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_stops</span><span class="params">()</span>:</span></span><br><span class="line">    assert_equal(lexicon.scan(<span class="string">"the"</span>), [(<span class="string">'stop'</span>, <span class="string">'the'</span>)])</span><br><span class="line">    result = lexicon.scan(<span class="string">"the in of"</span>)</span><br><span class="line">    assert_equal(result, [(<span class="string">'stop'</span>, <span class="string">'the'</span>),</span><br><span class="line">                          (<span class="string">'stop'</span>, <span class="string">'in'</span>),</span><br><span class="line">                          (<span class="string">'stop'</span>, <span class="string">'of'</span>)])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_nouns</span><span class="params">()</span>:</span></span><br><span class="line">    assert_equal(lexicon.scan(<span class="string">"bear"</span>), [(<span class="string">'noun'</span>, <span class="string">'bear'</span>)])</span><br><span class="line">    result = lexicon.scan(<span class="string">"bear princess"</span>)</span><br><span class="line">    assert_equal(result, [(<span class="string">'noun'</span>, <span class="string">'bear'</span>),</span><br><span class="line">                          (<span class="string">'noun'</span>, <span class="string">'princess'</span>)])</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_numbers</span><span class="params">()</span>:</span></span><br><span class="line">    assert_equal(lexicon.scan(<span class="string">"1234"</span>), [(<span class="string">'number'</span>, <span class="number">1234</span>)])</span><br><span class="line">    result = lexicon.scan(<span class="string">"3 91234"</span>)</span><br><span class="line">    assert_equal(result, [(<span class="string">'number'</span>, <span class="number">3</span>),</span><br><span class="line">                          (<span class="string">'number'</span>, <span class="number">91234</span>)])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_errors</span><span class="params">()</span>:</span></span><br><span class="line">    assert_equal(lexicon.scan(<span class="string">"ASDFADFASDF"</span>), [(<span class="string">'error'</span>, <span class="string">'ASDFADFASDF'</span>)])</span><br><span class="line">    result = lexicon.scan(<span class="string">"bear IAS princess"</span>)</span><br><span class="line">    assert_equal(result, [(<span class="string">'noun'</span>, <span class="string">'bear'</span>),</span><br><span class="line">                          (<span class="string">'error'</span>, <span class="string">'IAS'</span>),</span><br><span class="line">                          (<span class="string">'noun'</span>, <span class="string">'princess'</span>)])</span><br></pre></td></tr></table></figure>
<p>你需要用项目框架写出一个新的项目，就像你在练习47中做的一样。然后你需要创建这个测试用例以及你会用到的<code>lexicon.py</code>，看看测试用例顶部，看看它是如何被导入的。</p>
<p>接下来，按照我给你的提示写一些测试用例。看看我是如何做的：</p>
<blockquote>
<ol>
<li>在测试用例顶部写上导入（import），并保证它正常运行</li>
<li>创建第一个测试用例<code>test_directions</code>的空版本，并保证它正常运行</li>
<li>写出测试用例<code>test_directions</code>的第一行，保证它运行失败</li>
<li>到<code>lexicon.py</code>文件，创建一个空的<code>scan</code>方法</li>
<li>运行测试用例，至少保证<code>scan</code>方法运行，即便测试用例运行失败</li>
<li>为<code>scan</code>写出伪代码注释，用来说明<code>scan</code>如何通过<code>test_directions</code>测试</li>
<li>写出与注释相匹配的代码，保证<code>test_directions</code>测试通过 </li>
<li>回到方法<code>test_directions</code>，写完剩下的行</li>
<li>回到<code>lexicon.py</code>中的<code>scan</code>方法，补全代码直到<code>test_directions</code>测试通过 </li>
<li>这样，当你的第一个测试通过，你移动到下一个测试重复以上步骤。</li>
</ol>
</blockquote>
<p>只要你坚持在每次执行此过程中的一小块，你可以成功将大问题分解成更小的问题来解决。就像爬山的时候，你把整段路程分成一小段一小段。</p>
<h2 id="附加题"><a href="#附加题" class="headerlink" title="附加题"></a>附加题</h2><blockquote>
<ol>
<li>改进单元测试，让它覆盖到更多的语汇。</li>
<li>向语汇列表添加更多的语汇，并且更新单元测试代码。</li>
<li>让你的扫描器能够识别任意大小写的词汇。更新你的单元测试。</li>
<li>找出另外一种转换为数字的方法。</li>
<li>我的解决方案用了 37 行代码，你的是更长还是更短呢？</li>
</ol>
</blockquote>
<h2 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h2><h3 id="Q-为什么我一直有这个报错ImportErrors？"><a href="#Q-为什么我一直有这个报错ImportErrors？" class="headerlink" title="Q: 为什么我一直有这个报错ImportErrors？"></a>Q: 为什么我一直有这个报错<code>ImportErrors</code>？</h3><blockquote>
<p>导入异常通常有以下几点原因：1，在你的模块（modules）目录下没有生成<code>__init__.py</code>文件；2，你在错误的目录下启动服务；3，你导入的模块有拼写错误；4，你的<code>PYTHONPATH</code>没有设置成<code>.</code>。</p>
</blockquote>
<h3 id="Q-try-except和if-else有什么区别？"><a href="#Q-try-except和if-else有什么区别？" class="headerlink" title="Q: try-except和if-else有什么区别？"></a>Q: <code>try-except</code>和<code>if-else</code>有什么区别？</h3><blockquote>
<p><code>try-expect</code>是用来处理模块抛出的异常，永远都不能用<code>if-else</code>代替。</p>
</blockquote>
<h3 id="Q-有没有办法能实现在等待用户输入的时候，游戏也一样运行"><a href="#Q-有没有办法能实现在等待用户输入的时候，游戏也一样运行" class="headerlink" title="Q: 有没有办法能实现在等待用户输入的时候，游戏也一样运行"></a>Q: 有没有办法能实现在等待用户输入的时候，游戏也一样运行</h3><blockquote>
<p>我假设一种情况，你想实现用户在反应不够快的情况下会遭到怪物的攻击，这是可能的，但是它涉及的模块和技术是本书范围之外的。</p>
</blockquote>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/python/">python</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Python/">Python</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-learn-python-the-hard-way-exercise47" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2014/11/30/learn-python-the-hard-way-exercise47/" class="article-date">
  	<time datetime="2014-11-30T07:40:25.000Z" itemprop="datePublished">2014-11-30</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/11/30/learn-python-the-hard-way-exercise47/">笨办法学Python--exercise47.自动化测试</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>你需要一遍一遍地在你的游戏中输入命令，来测试游戏的功能是否正常。这个过程是很枯燥无味的。如果能写一小段代码用来测试你的代码岂不是更好？然后无论你对程序做了什么修改，或者添加了什么新东西，你只要“跑一下你的测试”，而这些测试能确认程序依然能正确运行。这些自动测试不会抓到所有的 bug，但可以让你无需重复输入命令运行你的代码，从而为你节约很多时间。</p>
<p>从这节练习开始，以后的练习将不会有“你应该看到的结果”部分，取而代之的是一个“你应该测试的东西”。从现在开始，你需要为自己写的所有代码写自动化测试，而这将让你成为一个更好的程序员。</p>
<p>我不会解释你为什么需要写自动化测试。我要告诉你的是，你想要成为一个程序员，而程序的作用是让无聊冗繁的工作自动化，测试一个软件毫无疑问是无聊冗繁的，所以你还是写点代码让它为你测试的更好。</p>
<p>这应该是你需要的所有的解释了。因为你写单元测试的原因是让你的大脑更加强健。读了这本书，你写了很多代码让它们实现一些事情。现在你将更进一步，写出懂得你写的其他代码的代码。这个写代码测试你写的其他代码的过程将强迫你清楚的理解你之前写的代码。这会让你更清晰地了解你写的代码实现的功能及其原理，而且让你对细节的注意更上一个台阶。</p>
<p>##　编写测试用例</p>
<p>我们将拿一段非常简单的代码为例，写一个简单的测试，这个测试将建立在上节我们创建的项目骨架上面。</p>
<p>首先从你的项目骨架创建一个叫做<code>ex47</code>的项目。下面是你要采取的步骤。我会给出文字说明，而不是直接告诉你该如何写代码，所以你要自己弄明白并写出代码。</p>
<blockquote>
<ol>
<li>复制<code>skeleton</code>到<code>ex47</code></li>
<li>将所有的<code>NAME</code>重命名为<code>ex47</code></li>
<li>修改所有文件中<code>NAME</code>为<code>ex47</code></li>
<li>最后删除所有的<code>*.pyc</code>文件</li>
</ol>
</blockquote>
<p>如果遇到什么困难，回顾一下练习46，如果你不能简单的完成这些，那你需要多练习几次。</p>
<blockquote>
<p><strong>NOTE:</strong><br>记得通过命令<code>nosetests</code>来检测你的测试代码没有错误信息。你可以通过<code>python ex47_tests.py</code>来运行，但是它不会那么容易的运行，你必须保证你的每一个测试文件正常运行。</p>
</blockquote>
<p>接下来创建一个简单的<code>ex47/game.py</code>文件，里边放一些用来被测试的代码。我们现在放一个傻乎乎的小 class 进去，用来作为我们的测试对象：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Room</span><span class="params">(object)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, description)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.description = description</span><br><span class="line">        self.paths = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">go</span><span class="params">(self, direction)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.paths.get(direction, <span class="keyword">None</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add_paths</span><span class="params">(self, paths)</span>:</span></span><br><span class="line">        self.paths.update(paths)</span><br></pre></td></tr></table></figure></p>
<p>准备好了这个文件，接下来把测试骨架改成这样子：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> nose.tools <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> ex47.game <span class="keyword">import</span> Room</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_room</span><span class="params">()</span>:</span></span><br><span class="line">    gold = Room(<span class="string">"GoldRoom"</span>, </span><br><span class="line">                <span class="string">"""This room has gold in it you can grab. There's a</span><br><span class="line">                door to the north."""</span>)</span><br><span class="line">    assert_equal(gold.name, <span class="string">"GoldRoom"</span>)</span><br><span class="line">    assert_equal(gold.paths, &#123;&#125;)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_room_paths</span><span class="params">()</span>:</span></span><br><span class="line">    center = Room(<span class="string">"Center"</span>, <span class="string">"Test room in the center."</span>)</span><br><span class="line">    north = Room(<span class="string">"North"</span>, <span class="string">"Test room in the north."</span>)</span><br><span class="line">    south = Room(<span class="string">"South"</span>, <span class="string">"Test room in the south."</span>)</span><br><span class="line"></span><br><span class="line">    center.add_paths(&#123;<span class="string">'north'</span>: north, <span class="string">'south'</span>: south&#125;)</span><br><span class="line">    assert_equal(center.go(<span class="string">'north'</span>), north)</span><br><span class="line">    assert_equal(center.go(<span class="string">'south'</span>), south)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_map</span><span class="params">()</span>:</span></span><br><span class="line">    start = Room(<span class="string">"Start"</span>, <span class="string">"You can go west and down a hole."</span>)</span><br><span class="line">    west = Room(<span class="string">"Trees"</span>, <span class="string">"There are trees here, you can go east."</span>)</span><br><span class="line">    down = Room(<span class="string">"Dungeon"</span>, <span class="string">"It's dark down here, you can go up."</span>)</span><br><span class="line"></span><br><span class="line">    start.add_paths(&#123;<span class="string">'west'</span>: west, <span class="string">'down'</span>: down&#125;)</span><br><span class="line">    west.add_paths(&#123;<span class="string">'east'</span>: start&#125;)</span><br><span class="line">    down.add_paths(&#123;<span class="string">'up'</span>: start&#125;)</span><br><span class="line"></span><br><span class="line">    assert_equal(start.go(<span class="string">'west'</span>), west)</span><br><span class="line">    assert_equal(start.go(<span class="string">'west'</span>).go(<span class="string">'east'</span>), start)</span><br><span class="line">    assert_equal(start.go(<span class="string">'down'</span>).go(<span class="string">'up'</span>), start)</span><br></pre></td></tr></table></figure></p>
<p>这个文件导入了你在<code>ex47.game</code>创建的<code>Room</code>这个类，接下来我们要做的就是测试它。于是我们看到一系列的以<code>test_</code>开头的测试函数，它们就是所谓的“测试用例(test case)”，每一个测试用例里面都有一小段代码，它们会创建一个或者一些房间，然后去确认房间的功能和你期望的是否一样。它测试了基本的房间功能，然后测试了路径，最后测试了整个地图。</p>
<p>这里最重要的函数是<code>assert_equal</code>，它保证了你设置的变量，以及你在<code>Room</code> 里设置的路径和你的期望相符。如果你得到错误的结果的话，<code>nosetests</code> 将会打印出一个错误信息，这样你就可以找到出错的地方并且修正过来。</p>
<h2 id="测试指南"><a href="#测试指南" class="headerlink" title="测试指南"></a>测试指南</h2><p>在写测试代码时，你可以照着下面这些不是很严格的指南来做：</p>
<blockquote>
<ol>
<li>测试脚本要放到<code>tests/</code>目录下，并且命名为<code>BLAH_tests.py</code>，否则 <code>nosetests</code>就不会执行你的测试脚本了。这样做还有一个好处就是防止测试代码和别的代码互相混掉。</li>
<li>为你的每一个模组写一个测试。</li>
<li>测试用例（函数）保持简短，但如果看上去不怎么整洁也没关系，测试用例一般都有点乱。</li>
<li>就算测试用例有些乱，也要试着让他们保持整洁，把里边重复的代码删掉。创建一些辅助函数来避免重复的代码。当你下次在改完代码需要改测试的时候，你会感谢我这一条建议的。重复的代码会让修改测试变得很难操作。</li>
<li>最后一条是别太把测试当做一回事。有时候，更好的方法是把代码和测试全部删掉，然后重新设计代码。</li>
</ol>
</blockquote>
<h2 id="你看到的结果"><a href="#你看到的结果" class="headerlink" title="你看到的结果"></a>你看到的结果</h2><pre><code>$ nosetests
...
----------------------------------------------------------------------
Ran 3 tests in 0.008s

OK
</code></pre><p>如果一切工作正常的话，你看到的结果应该就是这样。试着把代码改错几个地方，然后看错误信息会是什么，再把代码改正确。</p>
<h2 id="附加题"><a href="#附加题" class="headerlink" title="附加题"></a>附加题</h2><blockquote>
<ol>
<li>仔细读读<code>nosetest</code>相关的文档，再去了解一下其他的替代方案。</li>
<li>了解一下 Python 的 “doc tests” ，看看你是不是更喜欢这种测试方式。</li>
<li>改进你游戏里的 Room，然后用它重建你的游戏，这次重写，你需要一边写代码，一边把单元测试写出来。</li>
</ol>
</blockquote>
<h2 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h2><h3 id="Q-当我运行nosetest的时候，我遇到一个语法错误"><a href="#Q-当我运行nosetest的时候，我遇到一个语法错误" class="headerlink" title="Q: 当我运行nosetest的时候，我遇到一个语法错误"></a>Q: 当我运行<code>nosetest</code>的时候，我遇到一个语法错误</h3><blockquote>
<p>如果你遇到这个报错，看看错误信息是怎么说的，并改正该行或上一行的错误。类似<code>nosetest</code>的工具是在运行你的代码和测试代码，所以他可以像运行python一样发现你的语法错误。</p>
</blockquote>
<h3 id="Q-我无法导入ex47-game"><a href="#Q-我无法导入ex47-game" class="headerlink" title="Q: 我无法导入ex47.game"></a>Q: 我无法导入<code>ex47.game</code></h3><blockquote>
<p>确认你创建了<code>ex47/__init__.py</code>文件，参照练习46，看它是如何做的。如果这个文件没有问题，在OSX/Linux下执行:<code>export PYTHONPATH=.</code>在window下执行<code>$env:PYTHONPATH = &quot;$env:PYTHONPATH;.&quot;</code>，最后，确认你是用<code>nosetest</code>运行测试脚本，而不是用python。</p>
</blockquote>
<h3 id="Q-我运行nosetest的时候，遇到一个报错UserWarning"><a href="#Q-我运行nosetest的时候，遇到一个报错UserWarning" class="headerlink" title="Q: 我运行nosetest的时候，遇到一个报错UserWarning"></a>Q: 我运行<code>nosetest</code>的时候，遇到一个报错<code>UserWarning</code></h3><blockquote>
<p>你可能安装了两个版本的python或者没有使用<code>distribute</code>，按照我在练习46中所描述的安装<code>distribute</code>或<code>pip</code>。</p>
</blockquote>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/python/">python</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Python/">Python</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-learn-python-the-hard-way-exercise46" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2014/11/30/learn-python-the-hard-way-exercise46/" class="article-date">
  	<time datetime="2014-11-30T06:41:39.000Z" itemprop="datePublished">2014-11-30</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/11/30/learn-python-the-hard-way-exercise46/">笨办法学Python--exercise46.项目骨架</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>这里你将学会如何建立一个项目“骨架”目录。这个骨架目录具备让项目跑起来的所有基本内容。它里边会包含你的项目文件布局、自动化测试代码，模组，以及安装脚本。当你建立一个新项目的时候，只要把这个目录复制过去，改改目录的名字，再编辑里边的文件就行了。</p>
<h2 id="安装Python-软件包的"><a href="#安装Python-软件包的" class="headerlink" title="安装Python 软件包的"></a>安装Python 软件包的</h2><p>你需要使用pip预先安装一些软件包，不过问题就来了。我的本意是让这本书越清晰越干净越好，不过安装软件的方法是在是太多了，如果我要一步一步写下来，那 10 页都写不完，而且告诉你吧，我本来就是个懒人。</p>
<p>所以我不会提供详细的安装步骤了，我只会告诉你需要安装哪些东西，然后让你自己搞定。即使我给了你所需软件详尽的安装说明，你还是不得不与之奋斗。计算机更新换代非常频繁，你在安装过程中遇到问题的时候，可以在网上搜索解决方案。</p>
<p>你需要安装下面的软件包：</p>
<blockquote>
<ol>
<li>pip – <a href="http://pypi.python.org/pypi/pip" target="_blank" rel="external">http://pypi.python.org/pypi/pip</a></li>
<li>distribute – <a href="http://pypi.python.org/pypi/distribute" target="_blank" rel="external">http://pypi.python.org/pypi/distribute</a></li>
<li>nose – <a href="http://pypi.python.org/pypi/nose/" target="_blank" rel="external">http://pypi.python.org/pypi/nose/</a></li>
<li>virtualenv – <a href="http://pypi.python.org/pypi/virtualenv" target="_blank" rel="external">http://pypi.python.org/pypi/virtualenv</a></li>
</ol>
</blockquote>
<p>不要只是手动下载并且安装这些软件包，你应该看一下别人的建议，尤其看看针对你的操作系统别人是怎样建议你安装和使用的。同样的软件包在不一样的操作系统上面的安装方式是不一样的，不一样版本的 Linux 和 OSX 会有不同，而 Windows 更是不同。</p>
<p>我要预先警告你，这个过程会是相当无趣。在业内我们将这种事情叫做 “yak shaving(剃牦牛)”。它指的是在你做一件有意义的事情之前的一些准备工作，而这些准备工作又是及其无聊冗繁的。你要做一个很酷的 Python 项目，但是创建骨架目录需要你安装一些软件包，而安装软件包之前你还要安装软件包安装工具(package installer)，而要安装这个工具你还得先学会如何在你的操作系统下安装软件，真是烦不胜烦呀。</p>
<p>无论如何，还是克服困难把。你就把它当做进入编程俱乐部的一个考验。每个程序员都会经历这条道路，在每一段“酷”的背后总会有一段“烦”的。</p>
<blockquote>
<p><strong>NOTE:</strong><br>有时候python的安装程序不会把<code>C:\Python27\Script</code>加入到系统的<code>PATH</code>中，如果你遇到了这个问题，就参照练习0自己把这个目录加上：<code>[Environment]::SetEnvironmentVariable(&quot;Path&quot;, &quot;$env:Path;C:\Python27\Scripts&quot;, &quot;User&quot;)</code></p>
</blockquote>
<h2 id="创建骨架内容"><a href="#创建骨架内容" class="headerlink" title="创建骨架内容"></a>创建骨架内容</h2><p>首先使用下述命令创建你的骨架目录：</p>
<pre><code>$ mkdir projects
$ cd projects/
$ mkdir skeleton
$ cd skeleton
$ mkdir bin NAME tests docs
</code></pre><p>我使用了一个叫<code>projects</code>的目录，用来存放我自己的各个项目。然后我在里边建立了一个叫做<code>skeleton</code>的文件夹，这就是我们新项目的基础目录。其中叫做<code>NAME</code>的文件夹是你的项目的主文件夹，你可以将它任意取名。</p>
<p>接下来我们要配置一些初始文件：</p>
<pre><code>$ touch NAME/__init__.py
$ touch tests/__init__.py
</code></pre><p>在windows上，你可以这样配置初始文件：</p>
<pre><code>$ new-item -type file NAME/__init__.py
$ new-item -type file tests/__init__.py
</code></pre><p>以上命令为你创建了空的模组目录，以供你后面为其添加代码。然后我们需要建立一个<code>setup.py</code>文件，这个文件在安装项目的时候我们会用到它：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">from</span> setuptools <span class="keyword">import</span> setup</span><br><span class="line"><span class="keyword">except</span> ImportError:</span><br><span class="line">    <span class="keyword">from</span> distutils.core <span class="keyword">import</span> setup</span><br><span class="line"></span><br><span class="line">config = &#123;</span><br><span class="line">    <span class="string">'description'</span>: <span class="string">'My Project'</span>,</span><br><span class="line">    <span class="string">'author'</span>: <span class="string">'My Name'</span>,</span><br><span class="line">    <span class="string">'url'</span>: <span class="string">'URL to get it at.'</span>,</span><br><span class="line">    <span class="string">'download_url'</span>: <span class="string">'Where to download it.'</span>,</span><br><span class="line">    <span class="string">'author_email'</span>: <span class="string">'My email.'</span>,</span><br><span class="line">    <span class="string">'version'</span>: <span class="string">'0.1'</span>,</span><br><span class="line">    <span class="string">'install_requires'</span>: [<span class="string">'nose'</span>],</span><br><span class="line">    <span class="string">'packages'</span>: [<span class="string">'NAME'</span>],</span><br><span class="line">    <span class="string">'scripts'</span>: [],</span><br><span class="line">    <span class="string">'name'</span>: <span class="string">'projectname'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">setup(**config)</span><br></pre></td></tr></table></figure></p>
<p>编辑这个文件，把自己的联系方式写进去，然后放到那里就行了。</p>
<p>最后你需要一个简单的测试专用的骨架文件叫<code>tests/NAME_tests.py</code>：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> nose.tools <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> NAME</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">setup</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"SETUP!"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">teardown</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"TEAR DOWN!"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_basic</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"I RAN!"</span></span><br></pre></td></tr></table></figure></p>
<h2 id="最终的目录结构"><a href="#最终的目录结构" class="headerlink" title="最终的目录结构"></a>最终的目录结构</h2><p>当你完成一切设置,你的目录应该看起来像我在这里: </p>
<pre><code>skeleton/
     NAME/
         __init__.py
     bin/
     docs/
     setup.py
     tests/
         NAME_tests.py
         __init__.py
</code></pre><p>从现在开始，你应该在这个目录下运行命令。如果你不能执行<code>ls -R</code>命令并看到相似的目录结构，说明你在一个错误的目录下。比如，人们经常会到<code>tests/</code>目录下尝试执行文件，那肯定是无法运行的。要运行你应用的测试用例，你也应该在目录<code>tests/</code>的上一层目录执行，加入你这样执行：</p>
<pre><code>$ cd tests/   # WRONG! WRONG! WRONG!
$ nosetests

----------------------------------------------------------------------
Ran 0 tests in 0.000s

OK
</code></pre><p>那结果肯定是错误的，你应当在<code>tests/</code>目录的上一层目录执行，所以为了修正你的错误，你应该这样做：</p>
<pre><code>$ cd ..   # get out of tests/
$ ls      # CORRECT! you are now in the right spot
NAME                bin             docs            setup.py        tests
$ nosetests
.
----------------------------------------------------------------------
Ran 1 test in 0.004s

OK
</code></pre><p>一定要记住这一点，因为人们经常犯这个错误。</p>
<h2 id="测试你的配置"><a href="#测试你的配置" class="headerlink" title="测试你的配置"></a>测试你的配置</h2><p>安装了所有上面的软件包以后，你就可以做下面的事情了：</p>
<pre><code>$ nosetests
.
----------------------------------------------------------------------
Ran 1 test in 0.007s

OK
</code></pre><p>下一节练习中我会告诉你<code>nosetests</code>的功能，不过如果你没有看到上面的画面，那就说明你哪里出错了。确认一下你的<code>NAME</code>和<code>tests</code>目录下存在 <code>__init__.py</code>， 并且你没有把 <code>tests/NAME_tests.py</code> 命名错。</p>
<h2 id="使用这个项目骨架"><a href="#使用这个项目骨架" class="headerlink" title="使用这个项目骨架"></a>使用这个项目骨架</h2><p>剃牦牛的事情已经做的差不多了，以后每次你要新建一个项目时，只要做下面的事情就可以了：</p>
<blockquote>
<ol>
<li>拷贝这份骨架目录，把名字改成你新项目的名字。</li>
<li>再将<code>NAME</code>模组更名为你需要的名字，它可以是你项目的名字，当然别的名字也行。</li>
<li>编辑<code>setup.py</code>让它包含你新项目的相关信息。</li>
<li>重命名<code>tests/NAME_tests.py</code>，让它的名字匹配到你模组的名字。</li>
<li>使用<code>nosetests</code>检查有无错误。</li>
<li>开始写代码吧。</li>
</ol>
</blockquote>
<h2 id="小测验"><a href="#小测验" class="headerlink" title="小测验"></a>小测验</h2><p>本节没有附加题，不过有一些小测验需要你完成</p>
<blockquote>
<ol>
<li>找文档阅读，学会使用你前面安装了的软件包。</li>
<li>阅读关于<code>setup.py</code>的文档，看它里边可以做多少配置。Python 的安装器并不是一个好软件，所以使用起来也非常奇怪。</li>
<li>创建一个项目，在模组目录里写一些代码，并让这个模组可以运行。</li>
<li>在 <code>bin</code> 目录下放一个可以运行的脚本，找材料学习一下怎样创建可以在系统下运行的 Python 脚本。</li>
<li>在你的 <code>setup.py</code>中加入<code>bin</code>这个目录，这样你安装时就可以连它安装进去。</li>
<li>使用<code>setup.py</code>安装你的模组，并确定安装的模组可以正常使用，最后使用<code>pip</code>将其卸载。</li>
</ol>
</blockquote>
<h2 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h2><h3 id="Q-这些说明在windows上也是一样的吗？"><a href="#Q-这些说明在windows上也是一样的吗？" class="headerlink" title="Q: 这些说明在windows上也是一样的吗？"></a>Q: 这些说明在windows上也是一样的吗？</h3><blockquote>
<p>是的，不过也取决于你windows系统的版本，你可能需要在配置上下点功夫它才能正常运行，坚持研究并尝试，直到你能在windows上正常的运行这个骨架，或者你可以找一些有python+windows开发经验的人帮忙。</p>
</blockquote>
<h3 id="Q-我好像不能在windows上运行nosetests"><a href="#Q-我好像不能在windows上运行nosetests" class="headerlink" title="Q: 我好像不能在windows上运行nosetests"></a>Q: 我好像不能在windows上运行<code>nosetests</code></h3><blockquote>
<p>有时候python的安装程序不会把<code>C:\Python27\Script</code>加入到系统的<code>PATH</code>中，如果你遇到了这个问题，就参照练习0自己把这个目录加上：<code>[Environment]::SetEnvironmentVariable(&quot;Path&quot;, &quot;$env:Path;C:\Python27\Scripts&quot;, &quot;User&quot;)</code></p>
</blockquote>
<h3 id="Q-我应该在我的配置文件setup-py中放些什么？"><a href="#Q-我应该在我的配置文件setup-py中放些什么？" class="headerlink" title="Q: 我应该在我的配置文件setup.py中放些什么？"></a>Q: 我应该在我的配置文件<code>setup.py</code>中放些什么？</h3><blockquote>
<p>确认你阅读了distutils的文档<code>http://docs.python.org/distutils/setupscript.html</code>。</p>
</blockquote>
<h3 id="Q-我好像不能加载NAME模块，而且还有个”ImportError”报错"><a href="#Q-我好像不能加载NAME模块，而且还有个”ImportError”报错" class="headerlink" title="Q:我好像不能加载NAME模块，而且还有个”ImportError”报错"></a>Q:我好像不能加载<code>NAME</code>模块，而且还有个”ImportError”报错</h3><blockquote>
<p>确认你创建了<code>NAME/__init__.py</code>这个文件，如果你用的windows系统，确认你没有把这文件命名为<code>NAME/__init__.py.txt</code>，很多程序员都犯过这个错。</p>
</blockquote>
<h3 id="Q-我们为什么需要一个bin-文件夹"><a href="#Q-我们为什么需要一个bin-文件夹" class="headerlink" title="Q: 我们为什么需要一个bin/文件夹"></a>Q: 我们为什么需要一个<code>bin/</code>文件夹</h3><blockquote>
<p>这只是一个用来存放在命令行执行的脚本的地方，不是用来存在模块的。</p>
</blockquote>
<h3 id="Q-你有一个真实的项目举例吗？"><a href="#Q-你有一个真实的项目举例吗？" class="headerlink" title="Q: 你有一个真实的项目举例吗？"></a>Q: 你有一个真实的项目举例吗？</h3><blockquote>
<p>有很多python写的项目都可以作为实例，你可以看看我创建的这个简单的项目<code>https://gitorious.org/python-modargs</code>.</p>
</blockquote>
<h3 id="Q-我的nosetests运行时只显示正在运行一个测试，这是正确的吗？"><a href="#Q-我的nosetests运行时只显示正在运行一个测试，这是正确的吗？" class="headerlink" title="Q: 我的nosetests运行时只显示正在运行一个测试，这是正确的吗？"></a>Q: 我的<code>nosetests</code>运行时只显示正在运行一个测试，这是正确的吗？</h3><blockquote>
<p>是的，我的也是这么显示的。</p>
</blockquote>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/python/">python</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Python/">Python</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-learn-python-the-hard-way-exercise45" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2014/11/30/learn-python-the-hard-way-exercise45/" class="article-date">
  	<time datetime="2014-11-30T03:11:35.000Z" itemprop="datePublished">2014-11-30</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/11/30/learn-python-the-hard-way-exercise45/">笨办法学Python--exercise45.你来制作一个游戏</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>你要开始学会自食其力了。通过阅读这本书你应该已经学到了一点，那就是你需要的所有的信息网上都有，你只要去搜索就能找到。唯一困扰你的就是如何使用正确的词汇进行搜索。学到现在，你在挑选搜索关键字方面应该已经有些感觉了。现在已经是时候了，你需要尝试写一个大的项目，并让它运行起来。</p>
<p>以下是你的需求：</p>
<blockquote>
<ol>
<li>制作一个截然不同的游戏。</li>
<li>使用多个文件，并使用<code>import</code>调用这些文件。确认自己知道<code>import</code> 的用法。</li>
<li>对于每个房间使用一个 class，class 的命名要能体现出它的用处(例如 <code>GoldRoom</code>、<code>KoiPondRoom</code>)。</li>
<li>你的执行器代码应该了解这些房间，所以创建一个类来调用并且记录这些房间。有很多种方法可以达到这个目的，不过你可以考虑让每个房间返回下一个房间，或者设置一个变量，让它指定下一个房间是什么。</li>
</ol>
</blockquote>
<p>其他的事情就全靠你了。花一个星期完成这件任务，做一个你能做出来的最好的游戏。使用你学过的任何东西（类，函数，字典，列表……）来改进你的程序。这节课的目的是教你如何构建 class 出来，而这些 class 又能调用到其它 Python 文件中的 class。</p>
<p>我不会详细地告诉你告诉你怎样做，你需要自己完成。试着下手吧，编程就是解决问题的过程，这就意味着你要尝试各种可能性，进行实验，经历失败，然后丢掉你做出来的东西重头开始。当你被某个问题卡住的时候，你可以向别人寻求帮助，并把你的代码贴出来给他们看。如果有人刻薄你，别理他们，你只要集中精力在帮你的人身上就可以了。持续修改和清理你的代码，直到它完整可执行为止，然后再研究一下看它还能不能被改进。</p>
<p>祝你好运，下个星期你做出游戏后我们再见。</p>
<h2 id="评估你的游戏"><a href="#评估你的游戏" class="headerlink" title="评估你的游戏"></a>评估你的游戏</h2><p>这节练习的目的是检查评估你的游戏。也许你只完成了一半，卡在那里没有进行下去，也许你勉强做出来了。不管怎样，我们将串一下你应该弄懂的一些东西，并确认你的游戏里有使用到它们。我们将学习如何用正确的格式构建 class，使用 class 的一些通用习惯，另外还有很多的“书本知识”让你学习。</p>
<p>为什么我会让你先行尝试，然后才告诉你正确的做法呢？因为从现在开始你要学会“自给自足”，以前是我牵着你前行，以后就得靠你自己了。后面的习题我只会告诉你你的任务，你需要自己去完成，在你完成后我再告诉你如何可以改进你的作业。</p>
<p>一开始你会觉得很困难并且很不习惯，但只要坚持下去，你就会培养出自己解决问题的能力。你还会找出创新的方法解决问题，这比从课本中拷贝解决方案强多了。</p>
<h2 id="函数的风格"><a href="#函数的风格" class="headerlink" title="函数的风格"></a>函数的风格</h2><p>以前我教过的怎样写好函数的方法一样是适用的，不过这里要添加几条：</p>
<blockquote>
<ul>
<li>由于各种各样的原因，程序员将 class (类)里边的函数称作 method （方法）。很大程度上这只是个市场策略（用来推销 OOP），不过如果你把它们称作“函数”的话，是会有啰嗦的人跳出来纠正你的。如果你觉得他们太烦了，你可以告诉他们从数学方面演示一下“函数”和“方法”究竟有什么不同，这样他们会很快闭嘴的。</li>
<li>在你使用 class 的过程中，很大一部分时间是告诉你的 class 如何“做事情”。给这些函数命名的时候，与其命名成一个名词，不如命名为一个动词，作为给 class 的一个命令。就和 list 的 pop (抛出)函数一样，它相当于说：“嘿，列表，把这东西给我 pop 出去。”它的名字不是<code>remove_from_end_of_list</code> ，因为即使它的功能的确是这样，这一串字符也不是一个命令。</li>
<li>让你的函数保持简单小巧。由于某些原因，有些人开始学习 class 后就会忘了这一条。</li>
</ul>
</blockquote>
<h2 id="类的风格"><a href="#类的风格" class="headerlink" title="类的风格"></a>类的风格</h2><blockquote>
<ul>
<li>你的 class 应该使用 “camel case（驼峰式大小写）”，例如你应该使用 <code>SuperGoldFactory</code>而不是<code>super_gold_factory</code>。</li>
<li>你的 <code>__init__</code>不应该做太多的事情，这会让 class 变得难以使用。</li>
<li>你的其它函数应该使用 “underscore format（下划线隔词）”，所以你可以写<code>my_awesome_hair</code>，<br>而不是 <code>myawesomehair</code>或者<code>MyAwesomeHair</code>。</li>
<li>用一致的方式组织函数的参数。如果你的 class 需要处理 users、dogs、和 cats，就保持这个次序（特别情况除外）。如果一个函数的参数是<code>(dog, cat, user)</code>，另一个的是<code>(user, cat, dog)</code> ，这会让函数使用起来很困难。</li>
<li>不要对全局变量或者来自模组的变量进行重定义或者赋值，让这些东西自顾自就行了。</li>
<li>不要一根筋式地维持风格一致性，这是思维力底下的妖怪喽啰做的事情。一致性是好事情，不过愚蠢地跟着别人遵从一些白痴口号是错误的行为——这本身就是一种坏的风格。好好为自己着想吧。</li>
<li>永远永远都使用<code>class Name(object)</code>的方式定义 class，否则你会碰到大麻烦。</li>
</ul>
</blockquote>
<h2 id="代码风格"><a href="#代码风格" class="headerlink" title="代码风格"></a>代码风格</h2><blockquote>
<ul>
<li>为了以方便他人阅读，为自己的代码字符之间留下一些空白。你将会看到一些很差的程序员，他们写的代码还算通顺，但字符之间没有任何空间。这种风格在任何编程语言中都是坏习惯，人的眼睛和大脑会通过空白和垂直对齐的位置来扫描和区隔视觉元素，如果你的代码里没有任何空白，这相当于为你的代码上了迷彩装。</li>
<li>如果一段代码你无法朗读出来，那么这段代码的可读性可能就有问题。如你找不到让某个东西易用的方法，试着也朗读出来。这样不仅会逼迫你慢速而且真正仔细阅读过去，还会帮你找到难读的段落，从而知道那些代码的易读性需要作出改进。</li>
<li>学着模仿别人的风格写 Python 程序，直到哪天你找到你自己的风格为止。</li>
<li>一旦你有了自己的风格，也别把它太当回事。程序员工作的一部分就是和别人的代码打交道，有的人审美就是很差。相信我，你的审美某一方面一定也很差，只是你从未意识到而已。</li>
<li>如果你发现有人写的代码风格你很喜欢，那就模仿他们的风格。</li>
</ul>
</blockquote>
<h2 id="好的注释"><a href="#好的注释" class="headerlink" title="好的注释"></a>好的注释</h2><blockquote>
<ul>
<li>有程序员会告诉你，说你的代码需要有足够的可读性，这样你就无需写注释了。他们会以自己接近官腔的声音说“所以你永远都不应该写代码注释。”这些人要么是一些顾问型的人物，如果别人无法使用他们的代码，就会付更多钱给他们让他们解决问题。要么他们能力不足，从来没有跟别人合作过。别理会这些人，好好写你的注释。</li>
<li>写注释的时候，描述清楚为什么你要这样做。代码只会告诉你“这样实现”，而不会告诉你“为什么要这样实现”，而后者比前者更重要。</li>
<li>当你为函数写文档注释的时候，记得为别的代码使用者也写些东西。你不需要狂写一大堆，但一两句话写写这个函数的用法还是很有用的。</li>
<li>最后要说的是，虽然注释是好东西，太多的注释就不见得是了。而且注释也是需要维护的，你要尽量让注释短小精悍一语中的，如果你对代码做了更改，记得检查并更新相关的注释，确认它们还是正确的。</li>
</ul>
</blockquote>
<h2 id="为你的游戏评分"><a href="#为你的游戏评分" class="headerlink" title="为你的游戏评分"></a>为你的游戏评分</h2><p>现在我要求你假装成我，板起脸来，把你的代码打印出来，然后拿一支红笔，把代码中所有的错误都标出来。你要充分利用你在本章以及前面学到的知识。等你批改完了，我要求你把所有的错误改对。这个过程我需要你多重复几次，争取找到更多的可以改进的地方。使用我前面教过的方法，把代码分解成最细小的单元一一进行分析。</p>
<p>这个练习的目的是训练你对于细节的关注程度。等你检查完自己的代码，再找一段别人的代码用这种方法检查一遍。把代码打印出来，检查出所有代码和风格方面的错误，然后试着在不改坏别人代码的前提下把它们修改正确、</p>
<p>这周我要求你的事情就是批改和纠错，包含你自己的代码和别人的代码，再没有别的了。这节习题难度还是挺大，不过一旦你完成了任务，你学过的东西就会牢牢记在脑中。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/python/">python</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Python/">Python</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-learn-python-the-hard-way-exercise44" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2014/11/30/learn-python-the-hard-way-exercise44/" class="article-date">
  	<time datetime="2014-11-30T02:21:35.000Z" itemprop="datePublished">2014-11-30</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/11/30/learn-python-the-hard-way-exercise44/">笨办法学Python--exercise44.继承Vs.包含</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>在有关英雄战胜邪恶的童话中，总是有某种形式的黑暗森林。它可能是一个山洞，森林，另一个星球或者其他地方，每个人都知道英雄不应该去。当然，当不就之后坏人被你找到的时候，你发现，英雄已经去那个愚蠢的森林里杀坏人去了。看起来英雄进入了一种状态，这种状态要求英雄必须在这个邪恶的森林中冒险。 </p>
<p>在面向对象编程中，继承就是那个黑暗森林。有经验的程序员知道要避免这种邪恶,因为他们知道,黑暗森林深处有着多重继承这个邪恶的皇后。 她喜欢那她那庞大的牙齿吃掉软件和程序员。但这个森林是如此强大，如此诱人，几乎每一个程序员都必须进入它，与邪恶的皇后战斗，尽量做到全身而退，才可以称自己是真正的程序员。你不能抗拒的继承森林的诱惑，所以你进去了。冒险之后，你试着远离那个邪恶的森林，当你再次被迫进入的时候，你会携带一支军队进入（这段翻译的太烂了，实在没办法把编程和童话联系起来！）</p>
<p>这是一种有趣的方式来解说我要在这节练习教你的东西，它叫做继承，当你使用它的时候，一定要当心再当心。正在森林里和女王战斗的程序员可能告诉你你必须进去。他们这么说是因为他们需要你的帮忙，可能因为他们创建了太多他们已经无法掌控的东西。但是你一定要记得：</p>
<p>大多数继承的用途，可以简化或用组合物所取代，并应不惜一切代价避免多重继承。</p>
<h2 id="什么是继承"><a href="#什么是继承" class="headerlink" title="什么是继承"></a>什么是继承</h2><p>继承是用来描述一个类从它的父类那里获得大部分甚至全部父类的功能。当你写下<code>class Foo(Bar)</code>的时候，就发生了继承，这句代码的意思是“创建一个叫做Foo的类，并继承Bar” 。当你执行这句的时候，编程语言使得<code>Foo</code>的实例所有的行为都跟<code>Bar</code>的实例一样。这么做，可以让你在类<code>Bar</code>中放一些通用功能，而那些需要特殊定制的函数或功能可以放在类 <code>Foo</code> 中。</p>
<p>当你需要做这些特殊化函数编写的时候，父子类之间有3中交互方法：</p>
<blockquote>
<ol>
<li>子类的方法隐性继承父类方法</li>
<li>子类重写父类的方法</li>
<li>对子类的操作改变父类</li>
</ol>
</blockquote>
<p>我将按顺序给你展示这3种交互方式，并给你看它们的代码。</p>
<h3 id="隐性继承"><a href="#隐性继承" class="headerlink" title="隐性继承"></a>隐性继承</h3><p>首先，我将给你展示的是隐性继承发生在你在父类中定义了方法，而在子类中没有：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Parent</span><span class="params">(object)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">implicit</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"PARENT implicit()"</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Child</span><span class="params">(Parent)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">dad = Parent()</span><br><span class="line">son = Child()</span><br><span class="line"></span><br><span class="line">dad.implicit()</span><br><span class="line">son.implicit()</span><br></pre></td></tr></table></figure></p>
<p>在<code>class Child</code>下使用<code>pass</code>的目的是告诉Python，在这里你想要一个空白的块。这里创建了一个叫做<code>Child</code>的类，但是没有在这个类中定义任何性的方法。它将从类<code>Parent</code>继承获得所有的方法。当你执行这段代码的时候，你会看到：</p>
<pre><code>$ python ex44a.py
PARENT implicit()
PARENT implicit()
</code></pre><p>注意一下，尽管我再代码的13行调用了<code>son.implicit()</code>，而类<code>Child</code>并没有一个定义叫做<code>implicit</code>的方法，代码仍然正常工作了，因为它调用了<code>Parent</code>中定义的同名方法。这个高速你的是：如果你在基类(i.e., <code>Parent</code>)中定义了一个方法，那么所有的子类(i.e., <code>Child</code>) 都可以自动的获得这个功能。对于你需要在很多类中有重复的方法来说，非常方便。</p>
<h3 id="重写方法"><a href="#重写方法" class="headerlink" title="重写方法"></a>重写方法</h3><p>关于有些方法是隐式调用的问题原因在于有时候你想让子类有不同的表现。这时你想重写子类中的方法且有效的覆盖父类中的方法。要做到这一点，你只需要在子类中定义一个同名的方法就行，例如<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Parent</span><span class="params">(object)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">override</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"PARENT override()"</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Child</span><span class="params">(Parent)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">override</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"CHILD override()"</span></span><br><span class="line"></span><br><span class="line">dad = Parent()</span><br><span class="line">son = Child()</span><br><span class="line"></span><br><span class="line">dad.override()</span><br><span class="line">son.override()</span><br></pre></td></tr></table></figure></p>
<p>在这个例子中，两个类中我都有一个叫做<code>override</code>的方法，所以让我们来看看当你运行此例时都发生了什么</p>
<pre><code>$ python ex44b.py
PARENT override()
CHILD override()
</code></pre><p>你可以看到，当第14行执行时，它执行了父类的<code>override</code>方法，因为变量<code>dad</code>是一个父类实例，但是当第15行执行时，打印的是子类的<code>override</code>方法，这是因为<code>son</code>是一个子类的实例，这个子类重写了那个方法，定义了自己的版本。</p>
<p>休息以下，在继续下面的内容之前，尝试练习这两种方法。</p>
<h3 id="之前或之后改变父类"><a href="#之前或之后改变父类" class="headerlink" title="之前或之后改变父类"></a>之前或之后改变父类</h3><p>第三种使用继承的方式比较特别，你想在父类版本的方法执行行为前后给出些提示，你首先像上个例子那样重写了方法，接着你使用一个Python内建的叫做<code>super</code>的方法得到了父类版本的方法调用。以下这个例子就是这么做的，你可以感受一下上面的描述是什么意思。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Parent</span><span class="params">(object)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">altered</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"PARENT altered()"</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Child</span><span class="params">(Parent)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">altered</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"CHILD, BEFORE PARENT altered()"</span></span><br><span class="line">        super(Child, self).altered()</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"CHILD, AFTER PARENT altered()"</span></span><br><span class="line"></span><br><span class="line">dad = Parent()</span><br><span class="line">son = Child()</span><br><span class="line"></span><br><span class="line">dad.altered()</span><br><span class="line">son.altered()</span><br></pre></td></tr></table></figure>
<p>重要的地方在于9-11行，在<code>son.altered()</code>被调用前我做了如下操作：</p>
<blockquote>
<ol>
<li>因为我已经重写了子类的<code>Child.altered</code>方法，第9行的运行结果应该和你的期待是一样</li>
<li>在这个例子中，我打算使用<code>super</code>来得到父类的<code>Parent.altered</code>版本。</li>
<li>在第10行，我调用了<code>super(Child, self).altered()</code>方法, 这个方法能够意识到继承的发生，并给你获得类<code>Parent</code>。你可以这样读这行代码“调用<code>super</code>，参数为<code>Child</code>和<code>self</code>,然后不管它返回什么，调用方法<code>altered</code> ”</li>
<li>在这种情况下，父类的<code>Parent.altered</code>版本执行，并打印出父类的信息。</li>
<li>最后，代码从<code>Parent.altered</code> 返回， <code>Child.altered</code> 方法继续打印出剩下的信息。</li>
</ol>
</blockquote>
<p>运行了程序之后，你应该能看到下面的内容：</p>
<pre><code>$ python ex44c.py
PARENT altered()
CHILD, BEFORE PARENT altered()
PARENT altered()
CHILD, AFTER PARENT altered()
</code></pre><h3 id="三种组合使用"><a href="#三种组合使用" class="headerlink" title="三种组合使用"></a>三种组合使用</h3><p>为了论证上面的三种方式，我有一个最终版本的文件，该文件给你展示了每一种继承方式的交互：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Parent</span><span class="params">(object)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">override</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"PARENT override()"</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">implicit</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"PARENT implicit()"</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">altered</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"PARENT altered()"</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Child</span><span class="params">(Parent)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">override</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"CHILD override()"</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">altered</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"CHILD, BEFORE PARENT altered()"</span></span><br><span class="line">        super(Child, self).altered()</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"CHILD, AFTER PARENT altered()"</span></span><br><span class="line"></span><br><span class="line">dad = Parent()</span><br><span class="line">son = Child()</span><br><span class="line"></span><br><span class="line">dad.implicit()</span><br><span class="line">son.implicit()</span><br><span class="line"></span><br><span class="line">dad.override()</span><br><span class="line">son.override()</span><br><span class="line"></span><br><span class="line">dad.altered()</span><br><span class="line">son.altered()</span><br></pre></td></tr></table></figure></p>
<p>通读每一行代码，不管有没有被重写，写一个注释用来解释每一行实现了什么，然后将代码运行起来，确认你的结果和你的期望是否一致：</p>
<pre><code>$ python ex44d.py
PARENT implicit()
PARENT implicit()
PARENT override()
CHILD override()
PARENT altered()
CHILD, BEFORE PARENT altered()
PARENT altered()
CHILD, AFTER PARENT altered()
</code></pre><h3 id="使用super-的原因"><a href="#使用super-的原因" class="headerlink" title="使用super()的原因"></a>使用<code>super()</code>的原因</h3><p>这看起来应该是常识，但是随后我们即将进入一个叫做所多重继承的麻烦事。 多重继承是指当你定义一个的类的时候，从一个或多个类继承，例如:</p>
<pre><code>class SuperFun(Child, BadStuff):
    pass
</code></pre><p>上述代码的意思是, “创建一个叫做<code>SuperFun</code>的类，它同时继承类<code>Child</code> 和类 <code>BadStuff</code> .”</p>
<p>在这个例子中，只要你隐式的调用任何<code>SuperFun</code>的实例，Python把必须从类<code>Child</code>和<code>BadStuff</code>查询可能的函数，但是，查找也需要一个顺序。为了做到这点，Python使用”方法解析顺序”(MRO)和一种叫做C3的运算法则来直接获得。</p>
<p>因为MRO是复杂的，并使用了明确定义的算法，Python不能让你来获得正确的MRO，相反的，Python提供给你<code>super()</code>方法，它用来处理所有这一切你需要改变类型的行为，如同我在<code>Child.altered</code>所实现的。使用<code>super()</code>你不必担心得到的是否是正确的方法，Python会帮你找到正确的那个。</p>
<h3 id="init-中使用super"><a href="#init-中使用super" class="headerlink" title="__init__中使用super()"></a><code>__init__</code>中使用<code>super()</code></h3><p><code>super()</code>最常见的用途是在基类的<code>__init__</code>方法里。这通常是你需要在子类里实现什么事情，然后完成父类初始化的地方。以下是在类<code>Child</code>中这样做的一个简单的例子:</p>
<pre><code>class Child(Parent):

    def __init__(self, stuff):
        self.stuff = stuff
        super(Child, self).__init__()
</code></pre><p>除了我在<code>__init__</code>中初始化父类之前定义了一些变量，这个跟上面的例子<code>Child.altered</code>几乎是一样的。</p>
<h2 id="包含"><a href="#包含" class="headerlink" title="包含"></a>包含</h2><p>继承是有用的， 但另一种方式仅仅是用其他类和模块就做到了同样的事情， 而没有使用隐性继承。如果你看一下使用继承的三种方式，其中的两种方法涉及编写新的代码来替换或改变父类功能。这可以很容易地通过调用模块函数复制。下面是一个例子：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Other</span><span class="params">(object)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">override</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"OTHER override()"</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">implicit</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"OTHER implicit()"</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">altered</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"OTHER altered()"</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Child</span><span class="params">(object)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.other = Other()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">implicit</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.other.implicit()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">override</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"CHILD override()"</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">altered</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"CHILD, BEFORE OTHER altered()"</span></span><br><span class="line">        self.other.altered()</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"CHILD, AFTER OTHER altered()"</span></span><br><span class="line"></span><br><span class="line">son = Child()</span><br><span class="line"></span><br><span class="line">son.implicit()</span><br><span class="line">son.override()</span><br><span class="line">son.altered()</span><br></pre></td></tr></table></figure>
<p>在这段代码中，我没有使用名字<code>Parent</code>，因为没有父子的<code>is-a</code>关系了。这是一个<code>has-a</code>关系,在这个关系中<code>Child</code> <code>has-a</code> <code>Other</code>被用来保证代码的正常工作。当我运行代码时，看到以下输出： </p>
<pre><code>$ python ex44e.py
OTHER implicit()
CHILD override()
CHILD, BEFORE OTHER altered()
OTHER altered()
CHILD, AFTER OTHER altered()
</code></pre><p>你可以看到<code>Child</code>和<code>Other</code>中的大部分代码实现了相同的功能。唯一的不同之处在于我必须定义一个 <code>Child.implicit</code> 方法去做一个动作. 然后我可以问问自己，如果我需要一个<code>Other</code>类，是不是只要把它放在一个叫做<code>other.py</code>的模块中就可以?</p>
<h2 id="什么时候用继承，什么时候用包含"><a href="#什么时候用继承，什么时候用包含" class="headerlink" title="什么时候用继承，什么时候用包含"></a>什么时候用继承，什么时候用包含</h2><p>继承与包含的问题可以归结为试图解决可重复使用代码的问题。你不想在你的软件中有重复的代码，因为这不是高效的干净的代码。继承通过创建一种机制，让你在基类中有隐含的功能来解决这个问题。而包含则是通过给你的模块和函数可以在其他类别被调用来解决这个问题。</p>
<p>如果这两种方案都能解决代码复用问题的话，哪一个更合适呢？答案是主观的，这看起来是令人难以相信的，但是我会给你3个指导性原则：</p>
<blockquote>
<ol>
<li>不惜一切代价避免多重继承，因为它太复杂太不可靠。如果你必须要使用它，那么一定要知道类的层次结构，并花时间找到每一个类是从哪里来的。</li>
<li>将代码封装为模块，这样就可以在许多不同的地方或情况使用。</li>
<li>只有当有明显相关的可重用的代码，且在一个共同概念下时，可以使用继承。</li>
</ol>
</blockquote>
<p>不要变成规则的奴隶。关于面向对象编程要记住的是：这是一个程序员创建打包和共享代码的社会习俗。因为它是一个社会习俗，但在Python的法典中，你可能会因为跟你合作的人而被迫避开这些规则。在这种情况下，了解他们是如何使用规则的，然后去适应形势。</p>
<h2 id="附加题"><a href="#附加题" class="headerlink" title="附加题"></a>附加题</h2><p>这节练习中只有一个附加题，因为这其实是一个很大的练习。阅读 <code>http://www.python.org/dev/peps/pep-0008/</code> 并尝试将它应用到你的代码中。你会发现，有些内容跟你从这本书学到的不同，但是现在你应该能够理解他们的建议，并将其应用到自己的代码中。本书中剩余部分的代码可能会也可能不会遵循这些准则，这个要取决于这些准则是否会使代码更加混乱。我建议你也这样做，因为理解比让大家都对你深奥的知识有印象更重要。</p>
<h2 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h2><h3 id="Q-我如何更好的解决我以前没有遇到的问题？"><a href="#Q-我如何更好的解决我以前没有遇到的问题？" class="headerlink" title="Q: 我如何更好的解决我以前没有遇到的问题？"></a>Q: 我如何更好的解决我以前没有遇到的问题？</h3><blockquote>
<p>更好的解决问题的办法只有一个，那就是尽量多的自己解决遇到的问题。通常，人们遇到一个棘手的问题，就会冲出去寻找答案。当你必须要把事情做好的时候，这种方法很好，但是如果你有时间的话，最好还是自己想办法解决这个问题。尽你所能的思考这个问题，尝试一切可能的办法，直到你解决这个问题。在此之后你找到的答案，你觉得会更加令人满意，而且你还会得到更好的解决问题的方法。</p>
</blockquote>
<h3 id="Q-对象不是复制的类吗？"><a href="#Q-对象不是复制的类吗？" class="headerlink" title="Q: 对象不是复制的类吗？"></a>Q: 对象不是复制的类吗？</h3><blockquote>
<p>在某些语言里(比如 JavaScript) 是这样的。这些被称为原型的语言，这些语言中对象和类没有什么不同之处。然而在Python中，类作为模板，可以生成新对象，类似于如何使用模具制造硬币。</p>
</blockquote>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/python/">python</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Python/">Python</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-learn-python-the-hard-way-exercise43" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2014/11/29/learn-python-the-hard-way-exercise43/" class="article-date">
  	<time datetime="2014-11-29T14:11:18.000Z" itemprop="datePublished">2014-11-29</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/11/29/learn-python-the-hard-way-exercise43/">笨办法学Python--exercise43.基本的面向对象的分析和设计</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>在这节练习，我想给你介绍一个使用python创建某类东西的过程，也就是“面向对象编程”（OOP）。我把它叫做一个过程，是因为我将给出一系列按顺序进行的步骤，但是你也不应该死板的遵循这个步骤，企图用它解决所有难题。它们对于许多编程问题只是一个良好的开头，而不应该被认为是解决这些问题的唯一方法。这个过程只是一个你可以遵循的方法：</p>
<blockquote>
<ol>
<li>写出或画出你的问题</li>
<li>从1中提炼关键问题并搜索相关资料</li>
<li>为2中的问题创建一个有层次结构的类和对象映射 </li>
<li>编写类和测试代码，并保证他们运行</li>
<li>重复并精炼</li>
</ol>
</blockquote>
<p>按照这个顺序执行流程，叫做“自顶向下”的方式，意思是说，它从非常抽象宽松的想法开始，然后慢慢提炼，直到想法是坚实的东西，然后你再开始编码。</p>
<p>首先我只是写出这个问题，并试图想出任何我想要的东西就可以了。也许我会画一两个图表，或者某种可能的地图，甚至给自己写了一系列的电子邮件描述这个问题。这给了我表达了问题的关键概念的方法，并探测出我对于这个游戏有什么具体的想法和了解。</p>
<p>接下来，我浏览这些笔记，图表以及描述，通过这些记录我找到我需要的关键问题点。有一个简单的技巧：简单地列出你的笔记和图表中所有的名词和动词,然后写出他们是如何相关的。这一步其实也我为我下一步要写的类、对象、以及函数等提供了命名列表。我利用这个概念列表，研究任何我不明白的地方，如果我需要，我还可以进一步完善它们。</p>
<p>一旦我完成这个列表，我可以创建的一个简单的轮廓/树用来说明这些概念之间的关系。你还可以对着你的名词列表并询问“这个名词和其他的是一个概念吗？或者它们有一个通用的父类吗，那它们的父类是什么？”持续检查，直到你得到一个有层次结构的类，它应该像一棵简单的树或者图表。然后检查你的动词列表，看它们是否可以作为函数的名字添加到你的类树种。</p>
<p>随着这棵类树的生成，我坐下来写一些基本的框架代码，代码中只包括刚才提到的类，类中包含的函数。然后我再写一个测试用例，用来检验我刚才写的类是正确的。有时候我可能只需要在开始写一段测试代码，但是更多的时候，我需要写一段测试，再写一段代码，再写一段测试…直到整个项目完成。</p>
<p>最后，在我完成更多的工作之前，我周期性的重复和精炼这个流程，是他变得清楚和易于理解。如果我在一个没有预料到的地方被一些概念或问题卡住，我会停下来在这一小部分上投入更大的精力来分析解决，直到我解决了这问题，再继续下去。</p>
<p>这节练习中，我将通过建造一个游戏引擎带大家学习这一流程。</p>
<h2 id="分析一个简单的游戏引擎"><a href="#分析一个简单的游戏引擎" class="headerlink" title="分析一个简单的游戏引擎"></a>分析一个简单的游戏引擎</h2><p>我打算制作一个叫做 “Gothons from Planet Percal #25”的游戏，这个一个小型的太空冒险游戏。</p>
<h3 id="写或画出这个问题"><a href="#写或画出这个问题" class="headerlink" title="写或画出这个问题"></a>写或画出这个问题</h3><p>我为这个游戏写了一小段描述：</p>
<p>“外星人乘坐一个宇宙飞船入侵,我们的英雄需要通过一个迷宫似的房间击败他们,然后他才能逃入一个逃生舱到达下面的行星。游戏将更像一个有着文本输出和有趣的死法的Zork或冒险类型游戏。游戏将包括一个引擎运行充满房间或场景的地图。 当玩家进入房间，每个房间将打印自己的描述,然后告诉引擎运行下一个地图。”</p>
<p>我先描述每个场景：</p>
<p>Death<br>:   这是玩家死亡的场景，应该是有趣的。</p>
<p>Central Corridor<br>:   这是游戏的起点，在这里已经有一个外星人等待英雄的到来，它们需要被一个玩笑打败。</p>
<p>Laser Weapon Armory<br>:   这是英雄得到了中子弹获得的逃生舱之前要炸毁的船。它有一个需要英雄猜数的键盘。</p>
<p>The Bridge<br>:   和外星人战斗的另一个场景，英雄防止炸弹的地方。</p>
<p>Escape Pod<br>:   英雄逃脱的场景，但是需要英雄找对正确的逃生舱</p>
<p>现在，我可以绘制出它们的地图，或者对每个房间再多写一些描述，或者其他一些我脑中出现的想法。</p>
<h3 id="提取关键概念并研究他们"><a href="#提取关键概念并研究他们" class="headerlink" title="提取关键概念并研究他们"></a>提取关键概念并研究他们</h3><p>现在我已经有足够多的信息还提取出名词，并分析它们的类结构。首先我列出所有的名词：</p>
<blockquote>
<ul>
<li>Alien</li>
<li>Player</li>
<li>Ship</li>
<li>Maze</li>
<li>Room</li>
<li>Scene</li>
<li>Gothon</li>
<li>Escape Pod</li>
<li>Planet</li>
<li>Map</li>
<li>Engine</li>
<li>Death</li>
<li>Central Corridor</li>
<li>Laser Weapon Armory</li>
<li>The Bridge</li>
</ul>
</blockquote>
<p>我也可能要列出所有的动词，看它们能否作为函数的名字，不过现在我要先跳过这一步。</p>
<p>你需要研究所有你现在还不知道的概念。例如，我可能会玩几个这种类型的游戏，并确保知道他们是如何工作的。我可能会研究船舶和炸弹的设计和工作原理。也许我会研究怎么样将游戏中的数据或状态存储在数据库等一些技术上的问题。我做完这个研究之后，我可能会回到第1步重新开始，根据新的信息，重写描述和提取新的概念。</p>
<h3 id="创建一个层次结构的类和对象映射的概念"><a href="#创建一个层次结构的类和对象映射的概念" class="headerlink" title="创建一个层次结构的类和对象映射的概念"></a>创建一个层次结构的类和对象映射的概念</h3><p>当我完成上面的步骤，我通过思考“哪些是类似于其他东西的”，把名词列表转换成一个有层次结构的类树，同样，我也会思考，哪些单词是其他东西的基础呢？</p>
<p>马上我发现，”Room” 和 “Scene”对于我要做的事情来说基本上是一样的事情。在这个游戏中，我选择使用”Scene” 。接下来我发现，所有的特殊房间比如”Central Corridor”基本上也跟”Scene”是一样的。我发现”Death”也是一个”Scene”, 由于我选择了”Scene”而不是”Room”，你可以有一个“死亡场景”，而是不一个很奇怪的“死亡房间”。”Maze”和”Map”基本一样，所以我选择使用”Map”，因为我更多的时候都用它。我不想做一个战斗系统，所以我会先忽略”Alien”和 “Player”，但是会把他们保存下来以供以后使用。”Planet”也可能仅仅是另一个场景，而不是什么具体的事情。</p>
<p>在此之后，我开始创建一个层次结构的类：</p>
<blockquote>
<ul>
<li>Map</li>
<li>Engine</li>
<li>Scene<ul>
<li>Death</li>
<li>Central Corridor</li>
<li>Laser Weapon Armory</li>
<li>The Bridge</li>
<li>Escape Pod</li>
</ul>
</li>
</ul>
</blockquote>
<p>然后，我会找出说明中每个动词都需要什么行动。比如，我从说明中得知，我需要一个方法来”run”这个引擎，通过地图获得下一个场景”get the next scene”，获得”opening scene”，或者”enter”一个场景。我把这些加到类树里：</p>
<blockquote>
<ul>
<li>Map<br>- next_scene<br>- opening_scene</li>
<li>Engine<br>- play</li>
<li>Scene<br>- enter<br>* Death<br>* Central Corridor<br>* Laser Weapon Armory<br>* The Bridge<br>* Escape Pod</li>
</ul>
</blockquote>
<p>注意一下，我只是把<code>-enter</code>放到<code>Scene</code>下面，因为我知道所有的场景都会继承它并重写它。</p>
<h3 id="编码类和测试代码并运行它们"><a href="#编码类和测试代码并运行它们" class="headerlink" title="编码类和测试代码并运行它们"></a>编码类和测试代码并运行它们</h3><p>当我有了这个类树和一些功能之后，我在编辑器中打开源文件，并尝试编写代码。通常，我会复制粘贴这棵类树到源文件中，然后编辑它。下面是一个如何编码的小例子，文件末尾包含一个简单的测试用例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Scene</span><span class="params">(object)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">enter</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Engine</span><span class="params">(object)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, scene_map)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">play</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Death</span><span class="params">(Scene)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">enter</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CentralCorridor</span><span class="params">(Scene)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">enter</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LaserWeaponArmory</span><span class="params">(Scene)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">enter</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TheBridge</span><span class="params">(Scene)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">enter</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EscapePod</span><span class="params">(Scene)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">enter</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Map</span><span class="params">(object)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, start_scene)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">next_scene</span><span class="params">(self, scene_name)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">opening_scene</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">a_map = Map(<span class="string">'central_corridor'</span>)</span><br><span class="line">a_game = Engine(a_map)</span><br><span class="line">a_game.play()</span><br></pre></td></tr></table></figure>
<p>在这个文件中，你可以看到我只是复制了我想要的层次结构,然后一点点的补齐代码再运行它,看看它在这个基本结构中是否运行顺利。 在这节练习后面的部分，你会填补这段代码的其余部分，使其正常工作，以配合练习开头的游戏描述。</p>
<h3 id="重复并精炼"><a href="#重复并精炼" class="headerlink" title="重复并精炼"></a>重复并精炼</h3><p>在我提供的流程中，最后一步并不是实际意义上的一步，而是要做一个循环。在编程的世界里，你永远做不到一次通过，相反，你退回整个过程，并再次根据你从后面的步骤中了解到的信息完善它。有时候我已经到了第3步，但是我发现我还需要在第1、2步做更多工作，我会停下来并返回去完善它。有时候我也会突然灵光一闪，跳到最后，用我脑子里更好的解决方案编码实现，但是之后，我仍然会回去完成前面的步骤，以确保我的工作覆盖了所有的可能性。</p>
<p>在这一过程的另一个观点是，你不是仅在一个层面上使用这个流程，当你遇到某些特定问题的时候，你可以在任意一个层级上使用该流程。比方说，我不知道如何写<code>Engine.play</code>方法，我可以静下心来用这个流程只做这一种功能，直到弄清楚这个方法怎么写。</p>
<h2 id="自顶向下和自下而上"><a href="#自顶向下和自下而上" class="headerlink" title="自顶向下和自下而上"></a>自顶向下和自下而上</h2><p>因为这个流程在最抽象的概念（顶部）开始，然后再下降到实际执行过程中，因此这一流程通常标示为“自上而下”。我希望你使用这一流程，但你也应该知道，还有另一种方式来解决程序中的问题，这种方式是从代码开始，再“上升”到抽象的概念问题。这种方式被称为“自下而上”。下面是自下而下方式所遵循的步骤：</p>
<blockquote>
<ol>
<li>取一小块问题，编写一些代码，并让他勉强运行</li>
<li>完善代码，将其转换成一些更正式的包含类和自动化测试的代码。</li>
<li>提取其中的关键概念，并尝试找出研究他们。</li>
<li>写出到底发生了什么的描述。</li>
<li>继续完善代码，也可能是把它扔掉，并重新开始。</li>
<li>移动到其他问题上，重复步骤。</li>
</ol>
</blockquote>
<p>当你需要更优质的代码，并在代码中更自然的思考你要解决的问题时，这种方式更好一些。尤其是当你知道小块的难题,但没有足够的信息把握整个概念的时候，这个方式是一个解决问题很好的办法。将问题分解成碎片并探索代码,直到你解决这个问题。然而，你解决问题的途径可能是缓慢而曲折的，所以，我的这一流程中也包含后退并反复研究问题，直到你通过自己所为解决所有难题。</p>
<h2 id="“来自-Percal-25-号行星的哥顿人”的代码"><a href="#“来自-Percal-25-号行星的哥顿人”的代码" class="headerlink" title="“来自 Percal 25 号行星的哥顿人”的代码"></a>“来自 Percal 25 号行星的哥顿人”的代码</h2><p>我要告诉你我解决上述问题的最终办法,但我不希望你只是直接跳到这里并输入代码。我希望你能通过我的描述，完成我写的那个简单粗糙的代码框架，并让他运行起来。当你有了自己的解决方案时，你可以回来看看我是怎么解决的。</p>
<p>我准备把文件<code>ex43.py</code>拆成小块，再一一解释，而不是一次性提供完整的代码。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sys <span class="keyword">import</span> exit</span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> randint</span><br></pre></td></tr></table></figure></p>
<p>这只是我们游戏需要导入的包，没什么新奇的。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Scene</span><span class="params">(object)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">enter</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"This scene is not yet configured. Subclass it and implement enter()."</span></span><br><span class="line">        exit(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<p>正如你在框架代码里看到的，我创建了基础类<code>Scene</code>,它将包含所有scene要做的所有的事。在这段代码中，它们并没有做什么，所以这只是给你的一个如果创建基类的示范。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Engine</span><span class="params">(object)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, scene_map)</span>:</span></span><br><span class="line">        self.scene_map = scene_map</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">play</span><span class="params">(self)</span>:</span></span><br><span class="line">        current_scene = self.scene_map.opening_scene()</span><br><span class="line">        last_scene = self.scene_map.next_scene(<span class="string">'finished'</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> current_scene != last_scene:</span><br><span class="line">            next_scene_name = current_scene.enter()</span><br><span class="line">            current_scene = self.scene_map.next_scene(next_scene_name)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># be sure to print out the last scene</span></span><br><span class="line">        current_scene.enter()</span><br></pre></td></tr></table></figure>
<p>我同样创建了类<code>Engine</code>，并且你能看到我已经使用了方法<code>Map.opening_scene</code> 和 <code>Map.next_scene</code>。因为在我写<code>Map</code>类之前，做了一点计划，我可以假设我后面会写这些,然后提前使用它们。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Death</span><span class="params">(Scene)</span>:</span></span><br><span class="line"></span><br><span class="line">    quips = [</span><br><span class="line">        <span class="string">"You died.  You kinda suck at this."</span>,</span><br><span class="line">         <span class="string">"Your mom would be proud...if she were smarter."</span>,</span><br><span class="line">         <span class="string">"Such a luser."</span>,</span><br><span class="line">         <span class="string">"I have a small puppy that's better at this."</span></span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">enter</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">print</span> Death.quips[randint(<span class="number">0</span>, len(self.quips)<span class="number">-1</span>)]</span><br><span class="line">        exit(<span class="number">1</span>)</span><br></pre></td></tr></table></figure></p>
<p>我的第一个场景是一个叫做<code>Death</code>的场景，它给你展现了你能写的最简单的场景。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CentralCorridor</span><span class="params">(Scene)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">enter</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"The Gothons of Planet Percal #25 have invaded your ship and destroyed"</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"your entire crew.  You are the last surviving member and your last"</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"mission is to get the neutron destruct bomb from the Weapons Armory,"</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"put it in the bridge, and blow the ship up after getting into an "</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"escape pod."</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"\n"</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"You're running down the central corridor to the Weapons Armory when"</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"a Gothon jumps out, red scaly skin, dark grimy teeth, and evil clown costume"</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"flowing around his hate filled body.  He's blocking the door to the"</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"Armory and about to pull a weapon to blast you."</span></span><br><span class="line"></span><br><span class="line">        action = raw_input(<span class="string">"&gt; "</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> action == <span class="string">"shoot!"</span>:</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"Quick on the draw you yank out your blaster and fire it at the Gothon."</span></span><br><span class="line">            <span class="keyword">print</span> <span class="string">"His clown costume is flowing and moving around his body, which throws"</span></span><br><span class="line">            <span class="keyword">print</span> <span class="string">"off your aim.  Your laser hits his costume but misses him entirely.  This"</span></span><br><span class="line">            <span class="keyword">print</span> <span class="string">"completely ruins his brand new costume his mother bought him, which"</span></span><br><span class="line">            <span class="keyword">print</span> <span class="string">"makes him fly into an insane rage and blast you repeatedly in the face until"</span></span><br><span class="line">            <span class="keyword">print</span> <span class="string">"you are dead.  Then he eats you."</span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">'death'</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">elif</span> action == <span class="string">"dodge!"</span>:</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"Like a world class boxer you dodge, weave, slip and slide right"</span></span><br><span class="line">            <span class="keyword">print</span> <span class="string">"as the Gothon's blaster cranks a laser past your head."</span></span><br><span class="line">            <span class="keyword">print</span> <span class="string">"In the middle of your artful dodge your foot slips and you"</span></span><br><span class="line">            <span class="keyword">print</span> <span class="string">"bang your head on the metal wall and pass out."</span></span><br><span class="line">            <span class="keyword">print</span> <span class="string">"You wake up shortly after only to die as the Gothon stomps on"</span></span><br><span class="line">            <span class="keyword">print</span> <span class="string">"your head and eats you."</span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">'death'</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">elif</span> action == <span class="string">"tell a joke"</span>:</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"Lucky for you they made you learn Gothon insults in the academy."</span></span><br><span class="line">            <span class="keyword">print</span> <span class="string">"You tell the one Gothon joke you know:"</span></span><br><span class="line">            <span class="keyword">print</span> <span class="string">"Lbhe zbgure vf fb sng, jura fur fvgf nebhaq gur ubhfr, fur fvgf nebhaq gur ubhfr."</span></span><br><span class="line">            <span class="keyword">print</span> <span class="string">"The Gothon stops, tries not to laugh, then busts out laughing and can't move."</span></span><br><span class="line">            <span class="keyword">print</span> <span class="string">"While he's laughing you run up and shoot him square in the head"</span></span><br><span class="line">            <span class="keyword">print</span> <span class="string">"putting him down, then jump through the Weapon Armory door."</span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">'laser_weapon_armory'</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"DOES NOT COMPUTE!"</span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">'central_corridor'</span></span><br></pre></td></tr></table></figure></p>
<p>接下来，我创建了<code>CentralCorridor</code>，这是游戏的开始。我在写<code>Map</code>之前，为游戏制作了这个场景，是因为我后面要引用它们。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LaserWeaponArmory</span><span class="params">(Scene)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">enter</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"You do a dive roll into the Weapon Armory, crouch and scan the room"</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"for more Gothons that might be hiding.  It's dead quiet, too quiet."</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"You stand up and run to the far side of the room and find the"</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"neutron bomb in its container.  There's a keypad lock on the box"</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"and you need the code to get the bomb out.  If you get the code"</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"wrong 10 times then the lock closes forever and you can't"</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"get the bomb.  The code is 3 digits."</span></span><br><span class="line">        code = <span class="string">"%d%d%d"</span> % (randint(<span class="number">1</span>,<span class="number">9</span>), randint(<span class="number">1</span>,<span class="number">9</span>), randint(<span class="number">1</span>,<span class="number">9</span>))</span><br><span class="line">        guess = raw_input(<span class="string">"[keypad]&gt; "</span>)</span><br><span class="line">        guesses = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> guess != code <span class="keyword">and</span> guesses &lt; <span class="number">10</span>:</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"BZZZZEDDD!"</span></span><br><span class="line">            guesses += <span class="number">1</span></span><br><span class="line">            guess = raw_input(<span class="string">"[keypad]&gt; "</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> guess == code:</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"The container clicks open and the seal breaks, letting gas out."</span></span><br><span class="line">            <span class="keyword">print</span> <span class="string">"You grab the neutron bomb and run as fast as you can to the"</span></span><br><span class="line">            <span class="keyword">print</span> <span class="string">"bridge where you must place it in the right spot."</span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">'the_bridge'</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"The lock buzzes one last time and then you hear a sickening"</span></span><br><span class="line">            <span class="keyword">print</span> <span class="string">"melting sound as the mechanism is fused together."</span></span><br><span class="line">            <span class="keyword">print</span> <span class="string">"You decide to sit there, and finally the Gothons blow up the"</span></span><br><span class="line">            <span class="keyword">print</span> <span class="string">"ship from their ship and you die."</span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">'death'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TheBridge</span><span class="params">(Scene)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">enter</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"You burst onto the Bridge with the netron destruct bomb"</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"under your arm and surprise 5 Gothons who are trying to"</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"take control of the ship.  Each of them has an even uglier"</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"clown costume than the last.  They haven't pulled their"</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"weapons out yet, as they see the active bomb under your"</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"arm and don't want to set it off."</span></span><br><span class="line"></span><br><span class="line">        action = raw_input(<span class="string">"&gt; "</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> action == <span class="string">"throw the bomb"</span>:</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"In a panic you throw the bomb at the group of Gothons"</span></span><br><span class="line">            <span class="keyword">print</span> <span class="string">"and make a leap for the door.  Right as you drop it a"</span></span><br><span class="line">            <span class="keyword">print</span> <span class="string">"Gothon shoots you right in the back killing you."</span></span><br><span class="line">            <span class="keyword">print</span> <span class="string">"As you die you see another Gothon frantically try to disarm"</span></span><br><span class="line">            <span class="keyword">print</span> <span class="string">"the bomb. You die knowing they will probably blow up when"</span></span><br><span class="line">            <span class="keyword">print</span> <span class="string">"it goes off."</span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">'death'</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">elif</span> action == <span class="string">"slowly place the bomb"</span>:</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"You point your blaster at the bomb under your arm"</span></span><br><span class="line">            <span class="keyword">print</span> <span class="string">"and the Gothons put their hands up and start to sweat."</span></span><br><span class="line">            <span class="keyword">print</span> <span class="string">"You inch backward to the door, open it, and then carefully"</span></span><br><span class="line">            <span class="keyword">print</span> <span class="string">"place the bomb on the floor, pointing your blaster at it."</span></span><br><span class="line">            <span class="keyword">print</span> <span class="string">"You then jump back through the door, punch the close button"</span></span><br><span class="line">            <span class="keyword">print</span> <span class="string">"and blast the lock so the Gothons can't get out."</span></span><br><span class="line">            <span class="keyword">print</span> <span class="string">"Now that the bomb is placed you run to the escape pod to"</span></span><br><span class="line">            <span class="keyword">print</span> <span class="string">"get off this tin can."</span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">'escape_pod'</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"DOES NOT COMPUTE!"</span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">"the_bridge"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EscapePod</span><span class="params">(Scene)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">enter</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"You rush through the ship desperately trying to make it to"</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"the escape pod before the whole ship explodes.  It seems like"</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"hardly any Gothons are on the ship, so your run is clear of"</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"interference.  You get to the chamber with the escape pods, and"</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"now need to pick one to take.  Some of them could be damaged"</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"but you don't have time to look.  There's 5 pods, which one"</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"do you take?"</span></span><br><span class="line"></span><br><span class="line">        good_pod = randint(<span class="number">1</span>,<span class="number">5</span>)</span><br><span class="line">        guess = raw_input(<span class="string">"[pod #]&gt; "</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> int(guess) != good_pod:</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"You jump into pod %s and hit the eject button."</span> % guess</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"The pod escapes out into the void of space, then"</span></span><br><span class="line">            <span class="keyword">print</span> <span class="string">"implodes as the hull ruptures, crushing your body"</span></span><br><span class="line">            <span class="keyword">print</span> <span class="string">"into jam jelly."</span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">'death'</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"You jump into pod %s and hit the eject button."</span> % guess</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"The pod easily slides out into space heading to"</span></span><br><span class="line">            <span class="keyword">print</span> <span class="string">"the planet below.  As it flies to the planet, you look"</span></span><br><span class="line">            <span class="keyword">print</span> <span class="string">"back and see your ship implode then explode like a"</span></span><br><span class="line">            <span class="keyword">print</span> <span class="string">"bright star, taking out the Gothon ship at the same"</span></span><br><span class="line">            <span class="keyword">print</span> <span class="string">"time.  You won!"</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="string">'finished'</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Finished</span><span class="params">(Scene)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">enter</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"You won! Good job."</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">'finished'</span></span><br></pre></td></tr></table></figure></p>
<p>这是游戏剩下的场景。因为我知道我需要他们，并且已经想好他们应该如何交织在一起，所以我可以直接编码。</p>
<p>顺便说一下，我不是直接输入这些代码。记得我说过的吗，用增量的方法尝试构建所有的代码，一次只写一小部分。我只是给你看了最终的结果。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Map</span><span class="params">(object)</span>:</span></span><br><span class="line"></span><br><span class="line">    scenes = &#123;</span><br><span class="line">        <span class="string">'central_corridor'</span>: CentralCorridor(),</span><br><span class="line">        <span class="string">'laser_weapon_armory'</span>: LaserWeaponArmory(),</span><br><span class="line">        <span class="string">'the_bridge'</span>: TheBridge(),</span><br><span class="line">        <span class="string">'escape_pod'</span>: EscapePod(),</span><br><span class="line">        <span class="string">'death'</span>: Death(),</span><br><span class="line">        <span class="string">'finished'</span>: Finished(),</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, start_scene)</span>:</span></span><br><span class="line">        self.start_scene = start_scene</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">next_scene</span><span class="params">(self, scene_name)</span>:</span></span><br><span class="line">        val = Map.scenes.get(scene_name)</span><br><span class="line">        <span class="keyword">return</span> val</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">opening_scene</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.next_scene(self.start_scene)</span><br></pre></td></tr></table></figure>
<p>在这之后，我写了<code>Map</code>类，你可以看到它通过名字把所有的场景存在了字典中。我把这个字典叫做<code>Map.scenes</code>。这也是为什么map是在scens之后才写的原因，因为这个字典需要包含所有已存在的场景。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a_map = Map(<span class="string">'central_corridor'</span>)</span><br><span class="line">a_game = Engine(a_map)</span><br><span class="line">a_game.play()</span><br></pre></td></tr></table></figure></p>
<p>最后，我让我的代码通过创建一个<code>Map</code>，并在调用<code>play</code>之前把map交给<code>Engine</code>,把游戏运行起来，</p>
<h2 id="你看到的结果"><a href="#你看到的结果" class="headerlink" title="你看到的结果"></a>你看到的结果</h2><p>确保你明白这个游戏，并且首先尝试自己解决它。如果你被难住了，可以阅读一小部分我的代码，然后再尝试自己搞定它。</p>
<p>当我运行我的游戏的时候，我可以看到：</p>
<pre><code>$ python ex43.py
The Gothons of Planet Percal #25 have invaded your ship and destroyed
your entire crew.  You are the last surviving member and your last
mission is to get the neutron destruct bomb from the Weapons Armory,
put it in the bridge, and blow the ship up after getting into an
escape pod.


You&apos;re running down the central corridor to the Weapons Armory when
a Gothon jumps out, red scaly skin, dark grimy teeth, and evil clown costume
flowing around his hate filled body.  He&apos;s blocking the door to the
Armory and about to pull a weapon to blast you.
&gt;  dodge!
Like a world class boxer you dodge, weave, slip and slide right
as the Gothon&apos;s blaster cranks a laser past your head.
In the middle of your artful dodge your foot slips and you
bang your head on the metal wall and pass out.
You wake up shortly after only to die as the Gothon stomps on
your head and eats you.
Your mom would be proud...if she were smarter.
</code></pre><h2 id="附加题"><a href="#附加题" class="headerlink" title="附加题"></a>附加题</h2><blockquote>
<ol>
<li>修改这个游戏！你可能不喜欢这个游戏。让游戏运行起来，然后按照你的喜好修改它。这是你的电脑，你可以用它做你想做的事情</li>
<li>代码中有一个bug，为什么门锁了11次？</li>
<li>解释一下返回至下一个房间的工作原理。</li>
<li>增加作弊代码，这样你能通过一些更难的房间。我能只在一行上加两个单词做到这些。</li>
<li>回到我的描述和分析，尝试为英雄和他遇见的各种哥顿人创建一个小型作战系统。</li>
<li>这其实是一个小版本的“有限状态机(finite state machine)”，找资料阅读了解一下，虽然你可能看不懂，但还是找来看看吧。</li>
</ol>
</blockquote>
<h2 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h2><h3 id="Q-我在哪里可以为我的游戏找到故事情节"><a href="#Q-我在哪里可以为我的游戏找到故事情节" class="headerlink" title="Q: 我在哪里可以为我的游戏找到故事情节"></a>Q: 我在哪里可以为我的游戏找到故事情节</h3><blockquote>
<p>你可以就像给朋友讲述一个故事一样，来创建游戏。或者你可以采取简单的你喜欢的书或电影场景。 </p>
</blockquote>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/python/">python</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Python/">Python</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/page/2/">&laquo; Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/11/">11</a><a class="extend next" rel="next" href="/page/4/">Next &raquo;</a>
    </nav>
  
</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2016 flyouting and shirley
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
</body>
</html>